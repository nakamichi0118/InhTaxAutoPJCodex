# SOROBOCR 財産種別拡張ロードマップ仕様書

本ドキュメントは、相続税申告に必要な全財産種別への対応計画と各種別の処理仕様を定義します。

---

## 1. 現状と目標

### 1.1 現状（v0.8）
| 項目 | 状態 |
|------|------|
| 預貯金（通帳・取引履歴） | ✅ リリース済み |
| その他の財産種別 | ❌ 未実装 |

### 1.2 目標
相続税申告に必要な以下の全財産種別をOCR/構造化し、財産目録Excelへ取り込み可能にする。

| 財産種別 | asset_category | 優先度 | 入力書類例 |
|----------|---------------|--------|-----------|
| 預貯金 | `bank_deposit` | ✅完了 | 通帳、取引履歴、残高証明書 |
| 土地 | `land` | 高 | 登記簿謄本、名寄帳、固定資産税評価証明書 |
| 家屋 | `building` | 高 | 登記簿謄本、名寄帳、固定資産税評価証明書 |
| 有価証券 | `listed_security` | 高 | 証券会社残高証明書、株式数証明書 |
| 保険 | `insurance` | 中 | 保険証券、解約返戻金証明書 |
| その他財産 | `other` | 中 | 鑑定書、自動車検査証、貸付金契約書など |
| 債務 | `debt` | 中 | 金銭消費貸借契約書、固定資産税通知書、医療費領収書 |
| 葬式費用 | `funeral_expense` | 低 | 葬儀社領収書、お布施メモ、会葬御礼費用 |

---

## 2. アーキテクチャ方針

### 2.1 既存システムへの影響を最小化
```
[既存] 預金処理パイプライン（変更しない）
       ↓
[新規] 財産種別ごとの処理モジュールを追加
       ↓
[共通] CSV出力 (assets.csv) は既存スキーマを維持
```

### 2.2 モジュール構成案
```
backend/app/
├── main.py              # 既存（預金ジョブ）
├── parsers/             # 新規：財産種別パーサー
│   ├── __init__.py
│   ├── land_parser.py       # 土地
│   ├── building_parser.py   # 家屋
│   ├── security_parser.py   # 有価証券
│   ├── insurance_parser.py  # 保険
│   ├── debt_parser.py       # 債務
│   ├── funeral_parser.py    # 葬式費用
│   └── other_parser.py      # その他財産
├── prompts/             # 新規：Geminiプロンプトテンプレート
│   ├── land_prompt.py
│   ├── building_prompt.py
│   └── ...
└── validators/          # 新規：出力検証
    └── asset_validator.py
```

### 2.3 開発原則
1. **預金パイプラインは触らない** - リリース済み機能の安定性を最優先
2. **段階的リリース** - 財産種別ごとに独立してリリース可能な設計
3. **共通インターフェース** - 全パーサーは統一された入出力形式に従う
4. **テスト駆動** - 各財産種別に専用テストデータとユニットテストを用意

---

## 3. 財産種別ごとの詳細仕様

### 3.1 土地 (land)

#### 入力書類
| 書類 | 優先度 | 抽出情報 |
|------|--------|---------|
| 登記簿謄本（全部事項証明書） | 必須 | 所在、地番、地目、地積、所有者、持分 |
| 名寄帳 | 推奨 | 複数物件の一覧、評価額 |
| 固定資産税評価証明書 | 推奨 | 評価額、課税標準額 |

#### 出力フィールド（assets.csv）
| フィールド | 内容 | 例 |
|-----------|------|-----|
| `asset_category` | `land` | land |
| `asset_type` | 地目 | `residential`(宅地), `agricultural`(田畑), `forest`(山林) |
| `location_prefecture` | 都道府県 | 東京都 |
| `location_municipality` | 市区町村 | 渋谷区 |
| `location_detail` | 地番等 | 神宮前1丁目2番3 |
| `identifier_primary` | 地番 | 1-2-3 |
| `identifier_secondary` | 登記所名 | 東京法務局渋谷出張所 |
| `valuation_basis` | 評価根拠 | 固定資産税評価額 |
| `valuation_amount` | 評価額（円） | 50000000 |
| `ownership_share` | 持分（%） | 50.0 |

#### Geminiプロンプト要件
```
- 登記簿から所在・地番・地目・地積を正確に抽出
- 複数筆がある場合は1筆1レコードで出力
- 共有持分は分数表記（1/2）→パーセント変換（50.0）
- 地目コードの正規化（宅地→residential等）
```

---

### 3.2 家屋 (building)

#### 入力書類
| 書類 | 優先度 | 抽出情報 |
|------|--------|---------|
| 登記簿謄本（建物） | 必須 | 所在、家屋番号、種類、構造、床面積、所有者 |
| 名寄帳 | 推奨 | 複数物件の一覧 |
| 固定資産税評価証明書 | 推奨 | 評価額 |

#### 出力フィールド
| フィールド | 内容 | 例 |
|-----------|------|-----|
| `asset_category` | `building` | building |
| `asset_type` | 建物種類 | `residence`(居宅), `store`(店舗), `warehouse`(倉庫) |
| `location_detail` | 所在・家屋番号 | 渋谷区神宮前1-2-3 家屋番号123 |
| `identifier_primary` | 家屋番号 | 123 |
| `notes` | 構造・床面積 | 木造2階建 120.5㎡ |

---

### 3.3 有価証券 (listed_security)

#### 入力書類
| 書類 | 優先度 | 抽出情報 |
|------|--------|---------|
| 証券会社残高証明書 | 必須 | 銘柄、株数、評価額、口座番号 |
| 株式数証明書 | 補助 | 非上場株式の場合 |
| 配当金支払通知書 | 補助 | 銘柄確認用 |

#### 出力フィールド
| フィールド | 内容 | 例 |
|-----------|------|-----|
| `asset_category` | `listed_security` | listed_security |
| `asset_type` | 種別 | `stock`(株式), `bond`(債券), `mutual_fund`(投資信託) |
| `asset_name` | 銘柄名 | トヨタ自動車 |
| `identifier_primary` | 証券コード/ISIN | 7203 |
| `identifier_secondary` | 証券会社・口座 | 野村證券 12345678 |
| `valuation_amount` | 評価額 | 1500000 |
| `notes` | 株数等 | 100株 @15,000円 |

#### 特記事項
- 上場株式: 相続開始日の終値 or 月平均の最安値
- 投資信託: 基準価額×口数
- 非上場株式: 別途評価明細書が必要

---

### 3.4 保険 (insurance)

#### 入力書類
| 書類 | 優先度 | 抽出情報 |
|------|--------|---------|
| 保険証券 | 必須 | 保険会社、証券番号、契約者、被保険者、受取人 |
| 解約返戻金証明書 | 必須 | 解約返戻金額（生命保険の場合） |
| 保険金支払通知書 | 状況による | 死亡保険金額 |

#### 出力フィールド
| フィールド | 内容 | 例 |
|-----------|------|-----|
| `asset_category` | `insurance` | insurance |
| `asset_type` | 保険種別 | `life`(生命), `damage`(損害), `pension`(年金) |
| `asset_name` | 保険会社・商品名 | 日本生命 終身保険 |
| `identifier_primary` | 証券番号 | ABC-123456 |
| `owner_name` | 契約者 | 山田太郎 |
| `valuation_amount` | 解約返戻金/保険金 | 5000000 |
| `notes` | 被保険者・受取人 | 被: 山田太郎 受: 山田花子 |

---

### 3.5 その他財産 (other)

#### 対象
- 自動車
- 貴金属・骨董品
- 貸付金・未収金
- 電話加入権
- ゴルフ会員権
- 仮想通貨

#### 出力フィールド
基本的に `asset_type` と `notes` で詳細を記録。
```
asset_type: car / jewelry / loan / phone_right / golf_membership / crypto
```

---

### 3.6 債務 (debt)

#### 入力書類
| 書類 | 抽出情報 |
|------|---------|
| 金銭消費貸借契約書 | 借入先、借入額、残高 |
| 固定資産税通知書 | 未払税金 |
| 医療費領収書 | 未払医療費 |
| 公共料金請求書 | 未払公共料金 |

#### 出力フィールド
| フィールド | 内容 |
|-----------|------|
| `asset_category` | `debt` |
| `asset_type` | `loan`(借入金), `tax`(未払税金), `medical`(医療費), `utility`(公共料金) |
| `valuation_amount` | 債務額（マイナス値として出力するか要検討） |

---

### 3.7 葬式費用 (funeral_expense)

#### 入力書類
| 書類 | 抽出情報 |
|------|---------|
| 葬儀社領収書 | 葬儀一式費用 |
| お布施メモ | 寺院への支払い（領収書なしの場合あり） |
| 会葬御礼費用 | 返礼品費用 |

#### 出力フィールド
| フィールド | 内容 |
|-----------|------|
| `asset_category` | `funeral_expense` |
| `asset_type` | `funeral`(葬儀), `temple`(寺院), `gift`(返礼品) |
| `identifier_secondary` | 支払先 |
| `valuation_amount` | 費用額 |

---

## 4. 開発フェーズ

### Phase 1: 不動産（土地・家屋）- 名寄帳のみ方式
**目標**: 名寄帳/固定資産税評価証明書の読み取り（登記簿は対象外）

**設計判断（2026-01-16決定）**:
- 登記簿と名寄帳のマッチングは複雑すぎるため見送り
- 名寄帳だけで評価額・地積は100%取得可能
- 持分・登記地目はExcel側で手入力とする

| タスク | 詳細 |
|--------|------|
| Geminiプロンプト設計 | 名寄帳の自治体別フォーマット解析用プロンプト作成 |
| nayose_parser実装 | 名寄帳から土地・家屋情報を構造化 |
| テストデータ検証 | test/1回目～5回目の名寄帳で精度検証 |
| VBA取込対応 | 財産目録の土地・家屋シートへの取込マクロ（持分・地目は手入力欄）|

**出力項目**:
| 項目 | 名寄帳から取得 | 手入力 |
|------|--------------|--------|
| 所在地 | ✅ | - |
| 地番/家屋番号 | ✅ | - |
| 地目（課税） | ✅ | - |
| 地目（登記） | - | ✅ |
| 地積/床面積 | ✅ | - |
| 評価額 | ✅ | - |
| 持分 | - | ✅ |
| 構造・建築年（家屋） | ✅ | - |

### Phase 2: 有価証券
**目標**: 証券会社残高証明書の読み取り

| タスク | 詳細 |
|--------|------|
| 証券会社フォーマット調査 | 主要証券会社の残高証明書フォーマット確認 |
| security_parser実装 | 銘柄・株数・評価額の構造化 |
| 相続税評価額計算ロジック | 終値/月平均の選択ロジック |

### Phase 3: 保険・その他
**目標**: 保険証券、各種財産の読み取り

### Phase 4: 債務・葬式費用
**目標**: 控除項目の読み取り

---

## 5. テスト戦略

### 5.1 既存機能の保護
```bash
# 預金機能の回帰テスト（毎回実行）
pytest tests/test_bankbook_parser.py
pytest tests/test_date_inference.py
```

### 5.2 新規機能のテスト
```bash
# 財産種別ごとのユニットテスト
pytest tests/test_land_parser.py
pytest tests/test_building_parser.py
pytest tests/test_security_parser.py
```

### 5.3 統合テスト
- 複数の財産種別を含むPDFの一括処理
- 財産目録Excelへの取込検証

---

## 6. API拡張

### 6.1 エンドポイント設計
```
POST /api/jobs
  - document_type: bank_deposit | land | building | security | insurance | debt | funeral | other
  - 既存の預金処理と同じジョブフローを使用
```

### 6.2 レスポンス形式
既存の `assets.csv` スキーマを維持し、`asset_category` で種別を区別。

---

## 7. VBA取込拡張

### 7.1 現状
- `transaction_import.bas` - 預金取引の取込（完成）

### 7.2 追加予定
| モジュール | 対象シート | 機能 |
|-----------|-----------|------|
| `land_import.bas` | 土地 | 土地CSVの取込 |
| `building_import.bas` | 家屋 | 家屋CSVの取込 |
| `security_import.bas` | 有価証券 | 有価証券CSVの取込 |
| `insurance_import.bas` | 生命保険等 | 保険CSVの取込 |
| `debt_import.bas` | 債務 | 債務CSVの取込 |
| `funeral_import.bas` | 葬式費用 | 葬式費用CSVの取込 |

---

## 8. リスクと対策

| リスク | 対策 |
|--------|------|
| 預金機能への影響 | 預金パイプラインは独立維持、新機能は別モジュール |
| 書類フォーマットの多様性 | 主要書類から段階的に対応、ユーザー補正UI |
| Gemini精度 | 財産種別ごとに最適化されたプロンプト |
| 評価額計算の複雑さ | Phase 1は金額抽出のみ、評価計算は将来対応 |

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2026-01-16 | v0.1 | 初版作成 |
