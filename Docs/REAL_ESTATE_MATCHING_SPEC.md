# 不動産データマッチング設計書

## 1. 課題の整理

### 1.1 なぜマッチングが必要か

相続税申告における不動産評価には、**2種類の書類から異なる情報を取得**して統合する必要がある。

```
┌─────────────────────┐     ┌─────────────────────────┐
│    登記簿謄本        │     │ 固定資産税評価証明書     │
├─────────────────────┤     ├─────────────────────────┤
│ ・所在（法的住所）    │     │ ・所在地（課税住所）      │
│ ・地番              │     │ ・地積 ←【必要】        │
│ ・地目              │     │ ・評価額 ←【必要】       │
│ ・所有者・持分       │     │ ・課税標準額            │
│ ・構造（建物）       │     │                        │
│ ・床面積（建物）     │     │                        │
└─────────────────────┘     └─────────────────────────┘
           ↓                           ↓
      【突き合わせてマージ】
           ↓
┌─────────────────────────────────────────────────────┐
│              統合された不動産レコード                  │
├─────────────────────────────────────────────────────┤
│ 所在、地番、地目、地積、構造、評価額、持分...          │
└─────────────────────────────────────────────────────┘
```

### 1.2 書類間の関係性（重要）

```
┌─────────────────────────────────────────────────────────────┐
│   固定資産税通知書/評価証明書 (1ファイルに複数物件)           │
│   ┌─────────┬─────────┬─────────┬─────────┐               │
│   │ 物件A   │ 物件B   │ 物件C   │ 物件D   │               │
│   │ (土地)  │ (土地)  │ (建物)  │ (建物)  │               │
│   └────┬────┴────┬────┴────┬────┴────┬────┘               │
│        │         │         │         │                    │
└────────┼─────────┼─────────┼─────────┼────────────────────┘
         │         │         │         │
         ▼         ▼         ▼         ▼
┌────────────┐┌────────────┐┌────────────┐┌────────────┐
│ 登記簿A.pdf ││ 登記簿B.pdf ││ 登記簿C.pdf ││ 登記簿D.pdf │
│ (1物件のみ) ││ (1物件のみ) ││ (1物件のみ) ││ (1物件のみ) │
└────────────┘└────────────┘└────────────┘└────────────┘
```

**ポイント**:
- 固定資産税通知書/評価証明書 = **1ファイルに複数物件**（マスターリスト的役割）
- 登記簿謄本 = **1ファイルに1物件**（詳細情報）
- マッチングは「評価証明書の各レコード ↔ 対応する登記簿」の紐付け

### 1.3 マッチングが難しい理由

| 問題 | 例 |
|------|-----|
| **1対多の関係** | 評価証明書1枚に4物件、登記簿は4ファイル必要 |
| **住所表記の違い** | 登記: 「渋谷区神宮前一丁目2番3」 vs 評価証明: 「渋谷区神宮前1-2-3」 |
| **複数筆の存在** | 1つの土地が複数の地番で構成されている場合がある |
| **合筆・分筆** | 登記上の地番と課税上の地番が一致しない場合がある |
| **共有持分** | 複数所有者がいる場合、名寄帳に一部しか載らない |
| **建物の附属建物** | 主たる建物と附属建物で別々に記載される |
| **登記簿の欠落** | 全物件の登記簿が揃っていない場合がある |

---

## 2. 解決アプローチの比較

### アプローチA: 完全手動マッチング
```
ユーザーが目視で対応関係を指定
```
- ✅ 確実
- ❌ 作業負荷が高い
- ❌ スケールしない

### アプローチB: AI一括マッチング
```
Geminiに両方の書類を渡して一発でマッチング
```
- ✅ 簡単
- ❌ 精度が不安定
- ❌ エラー時のデバッグが困難

### アプローチC: 名寄帳マスター方式 ⭐推奨
```
名寄帳を「マスター」として使用し、登記簿で補完
```
- ✅ 名寄帳は1人の所有物件を網羅
- ✅ 地番・評価額・地積が1書類に含まれる
- ⚠️ 名寄帳がない場合の代替が必要

### アプローチD: 段階的マッチング ⭐推奨
```
1. 各書類を個別にOCR
2. AIでマッチング候補を提示
3. ユーザーが確認・修正
```
- ✅ AIの精度問題をユーザー確認で補完
- ✅ 柔軟性が高い
- ⚠️ UI設計が必要

---

## 3. 推奨実装方式

### 3.1 基本フロー

```
┌──────────────────────────────────────────────────────────────┐
│                     Step 1: 書類アップロード                   │
├──────────────────────────────────────────────────────────────┤
│  ユーザーが以下のいずれかをアップロード:                        │
│  ・名寄帳（推奨：これ1つで完結）                               │
│  ・登記簿 + 固定資産税評価証明書（組み合わせ）                  │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                     Step 2: 個別OCR処理                       │
├──────────────────────────────────────────────────────────────┤
│  各書類を独立してOCR → 中間JSON形式で保存                      │
│                                                              │
│  registry_records: [                                         │
│    { "location": "渋谷区...", "lot_number": "1-2-3", ... }   │
│  ]                                                           │
│  tax_records: [                                              │
│    { "location": "渋谷区...", "area": 150.5, "value": ... }  │
│  ]                                                           │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                     Step 3: マッチング候補生成                  │
├──────────────────────────────────────────────────────────────┤
│  AIまたはルールベースで候補を生成:                              │
│                                                              │
│  matches: [                                                  │
│    {                                                         │
│      "registry_id": "R001",                                  │
│      "tax_id": "T001",                                       │
│      "confidence": 0.95,                                     │
│      "reason": "地番完全一致"                                  │
│    },                                                        │
│    {                                                         │
│      "registry_id": "R002",                                  │
│      "tax_id": "T002",                                       │
│      "confidence": 0.70,                                     │
│      "reason": "住所類似（丁目表記の差異）"                     │
│    }                                                         │
│  ]                                                           │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                     Step 4: ユーザー確認UI                     │
├──────────────────────────────────────────────────────────────┤
│  ┌─────────────────┬─────────────────┬──────────┐            │
│  │ 登記簿          │ 評価証明書       │ 操作     │            │
│  ├─────────────────┼─────────────────┼──────────┤            │
│  │ 渋谷区神宮前    │ 渋谷区神宮前    │ ✅確定   │            │
│  │ 1-2-3          │ 1-2-3          │          │            │
│  │ 宅地           │ 150.5㎡        │          │            │
│  │                │ 5,000万円       │          │            │
│  ├─────────────────┼─────────────────┼──────────┤            │
│  │ 世田谷区...     │ （候補なし）     │ 🔍検索  │            │
│  └─────────────────┴─────────────────┴──────────┘            │
└──────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                     Step 5: 統合・CSV出力                      │
├──────────────────────────────────────────────────────────────┤
│  確定したマッチングを基に統合レコードを生成                      │
│  → assets.csv として出力                                      │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 マッチングロジック詳細

#### 3.2.1 正規化処理

マッチング前に住所を正規化:

```python
def normalize_address(raw: str) -> str:
    """
    住所表記を統一形式に正規化

    変換例:
    - "一丁目" → "1丁目"
    - "２番３号" → "2番3号"
    - "大字○○字△△" → "○○△△"
    - 全角数字 → 半角数字
    - スペース除去
    """
    pass

def normalize_lot_number(raw: str) -> str:
    """
    地番を統一形式に正規化

    変換例:
    - "123番地4" → "123-4"
    - "１２３－４" → "123-4"
    """
    pass
```

#### 3.2.2 マッチングスコア計算

```python
def calculate_match_score(registry: dict, tax: dict) -> float:
    """
    マッチング信頼度スコアを計算 (0.0 ~ 1.0)

    スコア加算ルール:
    - 地番完全一致: +0.5
    - 地番部分一致: +0.3
    - 市区町村一致: +0.2
    - 町名一致: +0.2
    - 地積が近い（±10%）: +0.1
    """
    score = 0.0

    # 地番比較
    if normalize_lot_number(registry['lot']) == normalize_lot_number(tax['lot']):
        score += 0.5
    elif partial_match(registry['lot'], tax['lot']):
        score += 0.3

    # 住所比較
    reg_addr = normalize_address(registry['location'])
    tax_addr = normalize_address(tax['location'])

    if same_municipality(reg_addr, tax_addr):
        score += 0.2
    if same_town(reg_addr, tax_addr):
        score += 0.2

    return min(score, 1.0)
```

#### 3.2.3 AI支援マッチング（補助）

ルールベースで低スコアの場合、Geminiに判断を委ねる:

```python
def ai_assisted_match(registry_records: list, tax_records: list) -> list:
    """
    Gemini APIを使用してマッチング候補を生成

    プロンプト例:
    「以下の登記簿レコードと固定資産税評価証明書レコードを
    　マッチングしてください。各ペアについて、
    　マッチング理由と信頼度(0-100)を返してください。」
    """
    pass
```

---

## 4. データ構造

### 4.1 中間形式（OCR結果）

```json
{
  "source_type": "registry",
  "source_file": "登記簿_渋谷区.pdf",
  "records": [
    {
      "id": "R001",
      "record_type": "land",
      "location": {
        "raw": "東京都渋谷区神宮前一丁目2番3",
        "normalized": "東京都渋谷区神宮前1丁目2-3",
        "prefecture": "東京都",
        "municipality": "渋谷区",
        "town": "神宮前1丁目",
        "lot_number": "2-3"
      },
      "land_category": "宅地",
      "area_registry": null,
      "owner": "山田太郎",
      "ownership_share": "1/2",
      "page": 1
    }
  ]
}
```

```json
{
  "source_type": "tax_certificate",
  "source_file": "固定資産税評価証明書.pdf",
  "records": [
    {
      "id": "T001",
      "record_type": "land",
      "location": {
        "raw": "渋谷区神宮前1-2-3",
        "normalized": "東京都渋谷区神宮前1丁目2-3",
        "lot_number": "2-3"
      },
      "area": 150.55,
      "assessed_value": 50000000,
      "tax_base": 48000000,
      "page": 1
    }
  ]
}
```

### 4.2 マッチング結果

```json
{
  "matches": [
    {
      "registry_id": "R001",
      "tax_id": "T001",
      "confidence": 0.95,
      "match_reason": "地番完全一致、市区町村一致",
      "status": "confirmed",
      "merged_record": {
        "asset_category": "land",
        "location_prefecture": "東京都",
        "location_municipality": "渋谷区",
        "location_detail": "神宮前1丁目2-3",
        "identifier_primary": "2-3",
        "land_category": "宅地",
        "area": 150.55,
        "valuation_basis": "固定資産税評価額",
        "valuation_amount": 50000000,
        "ownership_share": 50.0,
        "owner_name": "山田太郎"
      }
    }
  ],
  "unmatched_registry": [],
  "unmatched_tax": []
}
```

---

## 5. UI設計案

### 5.1 アップロード画面

```
┌────────────────────────────────────────────────────┐
│           不動産書類アップロード                     │
├────────────────────────────────────────────────────┤
│                                                    │
│  📁 名寄帳をお持ちの場合（推奨）                    │
│  ┌──────────────────────────────────────────┐     │
│  │  ここに名寄帳PDFをドロップ                │     │
│  └──────────────────────────────────────────┘     │
│                                                    │
│  ─────────── または ───────────                    │
│                                                    │
│  📁 登記簿 + 評価証明書の組み合わせ                 │
│  ┌─────────────────────┐ ┌─────────────────────┐  │
│  │ 登記簿PDF           │ │ 評価証明書PDF       │  │
│  └─────────────────────┘ └─────────────────────┘  │
│                                                    │
│               [ 解析開始 ]                         │
└────────────────────────────────────────────────────┘
```

### 5.2 マッチング確認画面

```
┌────────────────────────────────────────────────────────────────┐
│           不動産マッチング確認                                   │
├────────────────────────────────────────────────────────────────┤
│  ✅ 自動マッチング完了: 3件 / 未マッチング: 1件                  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  【マッチング済み】                                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ ● 渋谷区神宮前1-2-3 (宅地)                    信頼度 95%  │ │
│  │   登記: 地番2-3、所有者:山田太郎(1/2)                     │ │
│  │   評価: 150.55㎡、評価額 5,000万円                        │ │
│  │   [確定] [修正] [分離]                                    │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  【未マッチング - 登記簿のみ】                                   │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ ⚠ 世田谷区○○1-2-3                                        │ │
│  │   評価証明書に該当なし                                     │ │
│  │   [手動でマッチング] [評価額を手入力] [スキップ]           │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│                    [ 確定してCSV出力 ]                          │
└────────────────────────────────────────────────────────────────┘
```

---

## 6. 段階的実装計画

### Phase 1-A: 名寄帳単独対応（最優先）
名寄帳は1書類で以下が揃うため、マッチング不要:
- 所在・地番
- 地目・地積
- 評価額

**実装内容**:
- 名寄帳OCRプロンプト作成
- 名寄帳パーサー実装
- CSV出力

### Phase 1-B: 登記簿 + 評価証明書マッチング
名寄帳がない場合の代替フロー。

**実装内容**:
- 登記簿OCRプロンプト
- 評価証明書OCRプロンプト
- 住所正規化ロジック
- マッチングスコア計算
- マッチング確認UI

### Phase 1-C: 手動補正UI
マッチング失敗時のフォールバック。

**実装内容**:
- 手動マッチングUI
- 評価額手入力UI
- 未マッチングレコードの処理

---

## 7. 各書類の役割まとめ

| 書類 | 取得できる情報 | 取得できない情報 |
|------|--------------|----------------|
| **名寄帳** | 所在、地番、地目、地積、評価額 | 持分、構造詳細 |
| **登記簿** | 所在、地番、地目、持分、構造、所有者 | 評価額、正確な地積 |
| **評価証明書** | 所在、地積、評価額、課税標準 | 持分、構造 |

→ **名寄帳があればほぼ完結**。なければ登記簿+評価証明書の組み合わせ。

---

## 8. 未解決課題

1. **自治体による名寄帳フォーマットの違い** - 自治体ごとにフォーマットが異なる
2. **共有物件の扱い** - 名寄帳に他の共有者の情報がない場合
3. **相続発生後の名義変更前** - 被相続人名義でない場合の処理
4. **マンションの敷地権** - 敷地権割合の計算

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-16 | 初版作成 |
