<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOROBOCRï½œç›¸ç¶šæ›¸é¡OCR</title>
    <link rel="icon" type="image/png" href="./image/TitleLog.png">
    <!-- Handsontable for spreadsheet-like editing -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12/dist/handsontable.full.min.js"></script>
    <script>
        window.__ledger_app_url = window.__ledger_app_url || './ledger/';
        window.__ledger_api_base = window.__ledger_api_base || 'https://inhtaxautopjcodex-production.up.railway.app/api/ledger';
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        :root { color-scheme: light; }
        body {
            margin: 0;
            font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", system-ui, sans-serif;
            background: #f5f7fb;
            color: #1f2937;
        }
        header {
            position: relative;
            background: linear-gradient(135deg, #050d26 0%, #0d2765 55%, #15418f 100%);
            color: #fff;
            padding: 2.4rem 3.2rem 2.6rem;
            display: flex;
            flex-direction: column;
            gap: 1.6rem;
            overflow: hidden;
        }
        header::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 12% 18%, rgba(255, 255, 255, 0.16), transparent 55%),
                radial-gradient(circle at 88% 6%, rgba(96, 165, 250, 0.28), transparent 68%);
            pointer-events: none;
        }
        header > * {
            position: relative;
            z-index: 1;
        }
        header h1 {
            margin: 0;
            font-size: 2.6rem;
            font-weight: 700;
            letter-spacing: 0.04em;
        }
        header .tagline {
            margin: 0.4rem 0 0;
            max-width: 780px;
            font-size: 1.05rem;
            line-height: 1.8;
            color: rgba(239, 246, 255, 0.94);
        }
        .header-links {
            display: flex;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }
        .header-links a {
            color: #e0e7ff;
            text-decoration: none;
            border: 1px solid rgba(224, 231, 255, 0.5);
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            font-size: 0.9rem;
        }
        .header-links a.secondary-link {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .hero-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.6rem;
        }
        .hero-copy {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            text-align: left;
            max-width: 720px;
        }
        .hero-copy h1 {
            margin-bottom: 0;
        }
        .hero-subtitle {
            font-size: 0.95rem;
            letter-spacing: 0.28em;
            text-transform: uppercase;
            color: rgba(224, 231, 255, 0.75);
        }
        .tagline strong {
            font-weight: 600;
        }
        .optional-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            margin-left: 0.6rem;
            font-size: 0.75rem;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.18);
            color: #cbd5ff;
            letter-spacing: 0.05em;
        }
        header, section.card, footer {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        footer {
            background: linear-gradient(135deg, #050d26 0%, #0d2765 55%, #15418f 100%);
            color: rgba(236, 252, 255, 0.92);
            padding: 2rem 3rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            align-items: center;
            border-top: 1px solid rgba(59, 130, 246, 0.25);
        }
        .footer-logo {
            max-width: 220px;
            min-height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 10px 24px rgba(8, 16, 40, 0.45));
        }
        .footer-copy {
            font-size: 0.95rem;
            letter-spacing: 0.04em;
        }
        .pre-reveal {
            opacity: 0;
            transform: translateY(16px);
        }
        .revealed {
            opacity: 1;
            transform: translateY(0);
        }
        .version {
            margin-top: 0.2rem;
            font-size: 0.82rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(209, 224, 255, 0.68);
        }
        main {
            width: 100%;
            max-width: 1320px;
            margin: 0 auto;
            padding: 2.6rem 2.4rem 3.2rem;
            display: grid;
            gap: 1.8rem;
        }
        section.card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 20px;
            box-shadow: 0 22px 48px rgba(15, 23, 42, 0.14);
            padding: 2.2rem 2.4rem;
            border: 1px solid rgba(59, 130, 246, 0.16);
            backdrop-filter: blur(6px);
            width: 100%;
        }
        section.card h2 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f3b8c;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
        section.card p.description {
            margin: 0 0 1.2rem;
            font-size: 0.92rem;
            color: #4b5563;
            line-height: 1.6;
        }
        .input-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            align-items: center;
        }
        .text-input, select {
            padding: 0.55rem 0.75rem;
            border: 1px solid #cbd5f5;
            border-radius: 10px;
            min-width: 240px;
            font-size: 0.95rem;
            background: #f8fafc;
        }
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            border: none;
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        button.primary {
            background: #2563eb;
            color: #fff;
        }
        button.secondary {
            background: #e2e8f0;
            color: #1f2937;
        }
        button.small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none !important;
        }
        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.24);
        }
        .drop-area {
            border: 2px dashed #9cb7ff;
            border-radius: 14px;
            background: #f8fbff;
            padding: 2.2rem 1.2rem;
            text-align: center;
            transition: background 0.2s ease, border-color 0.2s ease;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0.6rem;
        }
        .drop-area.active {
            border-color: #2563eb;
            background: #e8f1ff;
        }
        .drop-area strong {
            display: block;
            font-size: 1.02rem;
            color: #1f3b8c;
            margin-bottom: 0.4rem;
        }
        .drop-area p {
            margin: 0.4rem 0;
            font-size: 0.95rem;
            color: #425079;
        }
        .status {
            margin-top: 1rem;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 0.92rem;
            line-height: 1.5;
            display: none;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .status.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .status.info { background: #eff6ff; color: #1e3a8a; border: 1px solid #bfdbfe; }
        .status.success { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
        .status.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .guidance-text {
            margin: 0.2rem 0 0.8rem;
            font-size: 0.85rem;
            color: #1f3b8c;
        }
        .notification-row {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.8rem;
        }
        .notification-row button {
            font-size: 0.85rem;
        }
        .cancel-row {
            display: none;
            margin-bottom: 0.8rem;
        }
        .summary-list {
            display: grid;
            gap: 0.6rem;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            font-size: 0.95rem;
        }
        .summary-list div {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
        }
        table.preview {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.88rem;
            background: #fff;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            overflow: hidden;
        }
        table.preview thead {
            background: #2563eb;
            color: #fff;
        }
        table.preview th, table.preview td {
            padding: 0.55rem 0.65rem;
            border-bottom: 1px solid #e5edff;
            text-align: left;
        }
        table.preview tbody tr:nth-child(even) {
            background: #f5f9ff;
        }
        .download-card {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #dbeafe;
            background: #f8fafc;
        }
        .download-card h3 {
            margin: 0;
            font-size: 1rem;
            color: #1d4ed8;
        }
        .ledger-cta {
            margin-top: 1.4rem;
            padding: 1.2rem 1.4rem;
            border-radius: 16px;
            border: 1px dashed #93c5fd;
            background: #eff6ff;
            display: none;
            flex-direction: column;
            gap: 0.65rem;
        }
        .ledger-cta h3 {
            margin: 0;
            font-size: 1.05rem;
            color: #0f172a;
        }
        .ledger-cta p {
            margin: 0;
            font-size: 0.9rem;
            color: #1e293b;
        }
        .asset-tabs {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        .asset-layout {
            display: grid;
            grid-template-columns: 240px minmax(0, 1fr);
            gap: 1.4rem;
        }
        .asset-nav {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            padding: 1rem;
            border-radius: 18px;
            background: rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(59, 130, 246, 0.08);
        }
        .asset-nav-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.65rem 0.9rem;
            border-radius: 12px;
            border: none;
            background: transparent;
            color: #1f2937;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        .asset-nav-button .coming {
            font-size: 0.72rem;
            color: #6b7280;
        }
        .asset-nav-button .lock-icon {
            font-size: 0.72rem;
            margin-left: 0.3rem;
        }
        .asset-nav-button.active {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(37, 99, 235, 0.28));
            color: #1d4ed8;
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.18);
        }
        .asset-nav-button[aria-disabled="true"] {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .asset-panels {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(59, 130, 246, 0.12);
            border-radius: 18px;
            box-shadow: 0 16px 36px rgba(15, 23, 42, 0.1);
            min-height: 260px;
            display: flex;
            flex-direction: column;
        }
        .asset-panel {
            display: none;
            padding: 1.6rem;
        }
        .asset-panel.active {
            display: block;
        }
        .asset-panel h3 {
            margin: 0 0 0.6rem;
            font-size: 1.05rem;
            color: #1f3b8c;
        }
        .asset-panel p.panel-description {
            margin: 0 0 1rem;
            font-size: 0.92rem;
            color: #4b5563;
        }
        .asset-panel .coming-soon {
            margin: 0;
            padding: 1rem;
            border-radius: 12px;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .doc-type-toggle {
            display: inline-flex;
            gap: 0.5rem;
            padding: 0.35rem;
            background: rgba(37, 99, 235, 0.08);
            border-radius: 999px;
            margin-bottom: 1rem;
        }
        .doc-type-option {
            border: none;
            background: transparent;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1f3b8c;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }
        .doc-type-option.active {
            background: #1d4ed8;
            color: #fff;
            box-shadow: 0 8px 16px rgba(29, 78, 216, 0.25);
        }
        .asset-panel-controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        .asset-panel-controls .input-row {
            margin: 0;
            align-items: center;
        }
        .asset-panel-controls .input-row > label {
            min-width: 140px;
            flex-shrink: 0;
        }
        .asset-panel-controls .input-row > select,
        .asset-panel-controls .input-row > input[type="date"] {
            width: 200px;
        }
        .tabs {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        .tab-headers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
        }
        .tab-headers button {
            border: 1px solid #cbd5f5;
            background: #f8fafc;
            color: #1f2937;
            padding: 0.45rem 0.85rem;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        .tab-headers button.active {
            background: #2563eb;
            color: #fff;
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.25);
            border-color: #1d4ed8;
        }

        .tab-panels .tab-panel {
            display: none;
        }
        .tab-panels .tab-panel.active {
            display: block;
        }
        .tab-panel .summary-list {
            margin-bottom: 1.2rem;
        }
        .tab-panel table.preview {
            margin-top: 0;
        }
        @media (max-width: 640px) {
            section.card { padding: 1.6rem 1.4rem; }
            .input-row { flex-direction: column; align-items: flex-start; }
            .text-input, select { width: 100%; }
            button { width: 100%; gap: 0.3rem; }
            .drop-area { padding: 1.8rem 1rem; }
            .hero-top { flex-direction: column-reverse; align-items: center; text-align: center; }
            .hero-copy { text-align: center; }
            .asset-layout { grid-template-columns: minmax(0, 1fr); }
            .asset-nav { flex-direction: row; overflow-x: auto; padding: 0.75rem; }
            .asset-nav-button { flex: 0 0 auto; min-width: 160px; }
        }
        /* JON API integration styles */
        .jon-container {
            margin-top: 1.2rem;
            padding: 1rem;
            border: 1px solid #dbeafe;
            border-radius: 12px;
            background: #f8fafc;
        }
        .jon-container h4 {
            margin: 0 0 0.8rem;
            font-size: 1rem;
            color: #1f3b8c;
        }
        .jon-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        .jon-option-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border: 1px solid #cbd5f5;
            border-radius: 8px;
            background: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .jon-option-label:hover {
            background: #eff6ff;
            border-color: #93c5fd;
        }
        .jon-option-label input[type="checkbox"] {
            accent-color: #2563eb;
        }
        .jon-option-label[data-disabled="true"] {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .jon-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 1rem;
        }
        .handsontable-wrapper {
            margin-top: 1rem;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            overflow: hidden;
        }
        .jon-results {
            margin-top: 1.2rem;
            padding: 1rem;
            border: 1px solid #6ee7b7;
            border-radius: 12px;
            background: #ecfdf5;
        }
        .jon-results h4 {
            margin: 0 0 0.8rem;
            font-size: 1rem;
            color: #047857;
        }
        .jon-result-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }
        .jon-result-table th {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            padding: 0.6rem 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.78rem;
            color: #065f46;
            white-space: nowrap;
            border-bottom: 2px solid #a7f3d0;
            letter-spacing: 0.02em;
        }
        .jon-result-table th:first-child { border-radius: 8px 0 0 0; }
        .jon-result-table th:last-child { border-radius: 0 8px 0 0; }
        .jon-result-table td {
            padding: 0.65rem 0.75rem;
            border-bottom: 1px solid #f0fdf4;
            vertical-align: middle;
        }
        .jon-result-table tbody tr { transition: background 0.15s; }
        .jon-result-table tbody tr:hover { background: #f0fdf4; }
        .jon-result-table tr:last-child td {
            border-bottom: none;
        }
        .jon-result-table .col-status { width: 64px; text-align: center; }
        .jon-result-table .col-type { width: 56px; text-align: center; }
        .jon-result-table .col-address { min-width: 200px; text-align: left; }
        .jon-result-table .col-accuracy { width: 72px; text-align: center; }
        .jon-result-table .col-link { width: 80px; text-align: center; }
        .jon-result-link {
            display: inline-block;
            color: #2563eb;
            text-decoration: none;
            white-space: nowrap;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .jon-result-link:hover {
            background: #eff6ff;
            color: #1d4ed8;
            text-decoration: none;
        }
        .jon-link-group {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .jon-progress {
            margin-top: 0.8rem;
            padding: 0.6rem;
            border-radius: 8px;
            background: #eff6ff;
            font-size: 0.9rem;
            color: #1e3a8a;
        }
        .jon-property-table {
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            background: #fff;
        }
        .jon-property-table table {
            margin: 0;
        }
        .jon-property-table th {
            font-weight: 600;
            font-size: 0.85rem;
            color: #475569;
        }
        .jon-property-table td {
            vertical-align: middle;
        }
        .jon-property-table input[type="checkbox"] {
            accent-color: #2563eb;
            width: 16px;
            height: 16px;
        }
        .property-type-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.04em;
        }
        .property-type-badge.land {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .property-type-badge.building {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .jon-status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            letter-spacing: 0.04em;
        }
        .jon-status-badge.pending { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .jon-status-badge.processing { background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .jon-status-badge.completed { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .jon-status-badge.failed { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .accuracy-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.72rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .accuracy-badge.high { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .accuracy-badge.medium { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .accuracy-badge.low { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .accuracy-warning {
            color: #dc2626;
            font-size: 0.8rem;
            margin-top: 0.3rem;
        }
        .accuracy-warning-container {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }
        .force-fetch-btn {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 0.2rem;
        }
        .force-fetch-btn:hover {
            background: #d97706;
        }
        .force-fetch-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        /* col-accuracy defined in main table styles */

    </style>
</head>
<body>
<header>
    <div class="hero-top" style="justify-content:flex-start;">
        <div class="hero-copy">
            <span class="hero-subtitle">ç›¸ç¶šæ›¸é¡ AI ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³</span>
            <h1>SOROBOCR</h1>
                    <p class="tagline">ç›¸ç¶šè²¡ç”£ã«é–¢ã‚ã‚‹ PDFãƒ»ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦è§£æã—ã€åˆ†é¡ã‹ã‚‰ CSV å‡ºåŠ›ã¾ã§ã‚’ãƒ¯ãƒ³ã‚¹ãƒˆãƒƒãƒ—ã§æ”¯æ´ã—ã¾ã™ã€‚</p>
                <p class="version">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 0.11.0</p>
            <div class="header-links">
                <a href="./help.html" target="_blank" rel="noopener">ä½¿ã„æ–¹ãƒ»FAQ</a>
                <a href="./ledger/" target="_blank" rel="noopener" class="secondary-link">å…¥å‡ºé‡‘æ¤œè¨è¡¨ãƒ„ãƒ¼ãƒ« Î²ç‰ˆ</a>
            </div>
        </div>
    </div>
</header>

<main>
    <section class="card" id="uploadSection">
        <h2>æ›¸é¡ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <p class="description">å¯¾è±¡ã®è²¡ç”£ã‚¿ãƒ–ã‚’é¸æŠã—ã€PDF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚å–å¼•å±¥æ­´ã‚¿ãƒ–ã§ã¯æ—¥ä»˜å½¢å¼ã‚’æŒ‡å®šã§ãã¾ã™ã€‚</p>
        <p class="guidance-text" id="uploadGuidance">èª­ã¿å–ã‚Šå¯èƒ½ã‚µã‚¤ã‚ºã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦</p>
        <div class="notification-row">
            <button type="button" class="secondary small" id="enableNotifications">èª­ã¿å–ã‚Šå®Œäº†ã‚’é€šçŸ¥</button>
        </div>
        <div class="cancel-row" id="cancelRow">
            <button type="button" class="secondary small" id="cancelProcessing">èª­ã¿å–ã‚Šã‚’ä¸­æ­¢</button>
        </div>
        <div id="assetTabsRoot" class="asset-tabs"></div>
        <div id="status" class="status info"></div>
    </section>

    <section class="card" id="resultsSection" style="display:none;">
        <h2>èª­ã¿å–ã‚Šçµæœï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</h2>
        <p class="description" style="margin-top:-0.6rem;">ä¸‹è¨˜ã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã™ã€‚CSVã§ç¢ºå®šå€¤ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ä¸‹éƒ¨ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
        <div id="tabContainer" class="tabs" style="display:none;">
            <div id="tabHeaders" class="tab-headers"></div>
            <div id="tabPanels" class="tab-panels"></div>
        </div>
        <p id="tabEmptyMessage" style="margin:0;color:#4b5563;display:none;">èª­ã¿å–ã‚ŠçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </section>

    <section class="card" id="downloadSection" style="display:none;">
        <h2>CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
        <p class="description" style="margin-top:-0.6rem;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ãŸã†ãˆã§ã€å¿…è¦ãªæ›¸é¡ã®èª­ã¿å–ã‚Šçµæœã‚’ CSV ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
        <div id="downloadList" class="summary-list" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));"></div>
        <div id="ledgerShortcut" class="ledger-cta">
            <div>
                <h3>å…¥å‡ºé‡‘æ¤œè¨è¡¨ãƒ„ãƒ¼ãƒ«ã«é€ã‚‹ï¼ˆÎ²ç‰ˆï¼‰</h3>
                <p id="ledgerPendingMessage">CSV ã‚’ä¿å­˜ã—ãŸå¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å…¥å‡ºé‡‘ã‚’ä¸¦ã¹æ›¿ãˆãƒ»è‰²ä»˜ã‘ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã‘ã¾ã™ã€‚</p>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:0.8rem;align-items:center;">
                <button type="button" class="primary small" id="openLedgerButton">å…¥å‡ºé‡‘æ¤œè¨è¡¨ã‚’é–‹ãï¼ˆÎ²ç‰ˆï¼‰</button>
                <span style="font-size:0.8rem;color:#475569;">â€»FastAPI (Railway) ã«CSVã‚’ä¿å­˜ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§ç·¨é›†ã§ãã¾ã™ã€‚</span>
            </div>
        </div>
        <details style="margin-top:1.2rem;">
            <summary>èª­ã¿å–ã£ãŸå†…å®¹ã‚’ JSON ã§ç¢ºèªã™ã‚‹ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰</summary>
            <pre id="rawJson"></pre>
        </details>
    </section>
</main>
<footer>
    <img src="./image/iucglog.png" alt="IU Consulting Group ãƒ­ã‚´" class="footer-logo">
    <div class="footer-copy">Â© <script>document.write(new Date().getFullYear())</script> IU Consulting Group. All Rights Reserved.</div>
</footer>

<script>
(() => {
    const DEFAULT_API = 'https://inhtaxautopjcodex-production.up.railway.app/api';
    const assetTabsRoot = document.getElementById('assetTabsRoot');
    const statusBox = document.getElementById('status');
    const resultsSection = document.getElementById('resultsSection');
    const tabContainer = document.getElementById('tabContainer');
    const tabHeaders = document.getElementById('tabHeaders');
    const tabPanels = document.getElementById('tabPanels');
    const tabEmptyMessage = document.getElementById('tabEmptyMessage');
    const downloadSection = document.getElementById('downloadSection');
    const downloadList = document.getElementById('downloadList');
    const ledgerShortcut = document.getElementById('ledgerShortcut');
    const openLedgerButton = document.getElementById('openLedgerButton');
    const ledgerPendingMessage = document.getElementById('ledgerPendingMessage');
    const rawJson = document.getElementById('rawJson');
    const uploadGuidance = document.getElementById('uploadGuidance');
    const notificationButton = document.getElementById('enableNotifications');
    const cancelButton = document.getElementById('cancelProcessing');
    const cancelRow = document.getElementById('cancelRow');
    const LEDGER_APP_URL =
        typeof window.__ledger_app_url === 'string' && window.__ledger_app_url.trim()
            ? window.__ledger_app_url
            : './ledger/';
    const LEDGER_API_BASE =
        typeof window.__ledger_api_base === 'string' && window.__ledger_api_base.trim()
            ? window.__ledger_api_base
            : null;
    const LEDGER_APP_ID =
        typeof window.__app_id === 'string' && window.__app_id.trim()
            ? window.__app_id.trim()
            : 'ledger-app';
    const LEDGER_SESSION_KEY = 'ledger_session_token';
    const PENDING_IMPORT_STORAGE_KEY = 'pending_ledger_imports';

    const state = {
        documents: [],
        activeDocId: null,
        activeAssetTabId: null,
        apiBase: DEFAULT_API,
        limits: null,
        notificationsEnabled: false,
        cancelRequested: false,
        isProcessing: false,
        currentAbortController: null,
        analysisMode: 'gemini_pro',
        latestJobId: null,
        ledgerToken: null,
        pendingImportCount: 0,
        unlockedTabs: new Set(),  // ãƒ­ãƒƒã‚¯è§£é™¤ã•ã‚ŒãŸã‚¿ãƒ–ã®IDã‚’ä¿æŒ
    };
    state.pendingImportCount = loadPendingImportEntries().length;
    state.ledgerToken = getStoredLedgerToken();

    function buildLedgerUrl(jobId) {
        const url = new URL(LEDGER_APP_URL, window.location.origin);
        if (jobId) {
            url.searchParams.set('job_id', jobId);
        }
        return url.href || url.toString();
    }

    function updateLedgerPendingMessage() {
        if (!ledgerPendingMessage) {
            return;
        }
        if (state.pendingImportCount > 0) {
            ledgerPendingMessage.textContent = `æœªç™»éŒ²ã®å£åº§å€™è£œãŒ ${state.pendingImportCount} ä»¶ã‚ã‚Šã¾ã™ã€‚å…¥å‡ºé‡‘æ¤œè¨è¡¨ã§å–ã‚Šè¾¼ã¿ã¾ã—ã‚‡ã†ã€‚`;
        } else {
            ledgerPendingMessage.textContent = 'CSV ã‚’ä¿å­˜ã—ãŸå¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å…¥å‡ºé‡‘ã‚’ä¸¦ã¹æ›¿ãˆãƒ»è‰²ä»˜ã‘ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã‘ã¾ã™ã€‚';
        }
    }

    function getStoredLedgerToken() {
        if (!window?.localStorage) {
            return null;
        }
        try {
            return window.localStorage.getItem(LEDGER_SESSION_KEY);
        } catch (error) {
            console.warn('Failed to read ledger token from storage:', error);
            return null;
        }
    }

    function persistLedgerToken(token) {
        if (!window?.localStorage) {
            return;
        }
        try {
            window.localStorage.setItem(LEDGER_SESSION_KEY, token);
        } catch (error) {
            console.warn('Failed to persist ledger token:', error);
        }
    }

    async function ensureLedgerSessionToken() {
        if (!LEDGER_API_BASE) {
            return null;
        }
        if (state.ledgerToken) {
            return state.ledgerToken;
        }
        const stored = getStoredLedgerToken();
        if (stored) {
            state.ledgerToken = stored;
            return stored;
        }
        const response = await fetch(`${LEDGER_API_BASE}/session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_id: LEDGER_APP_ID }),
        });
        if (!response.ok) {
            throw new Error('Ledgerã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
        const payload = await response.json();
        const token = payload.session_token;
        state.ledgerToken = token;
        persistLedgerToken(token);
        return token;
    }

    function loadPendingImportEntries() {
        if (!window?.localStorage) {
            return [];
        }
        try {
            const raw = window.localStorage.getItem(PENDING_IMPORT_STORAGE_KEY);
            if (!raw) {
                return [];
            }
            const parsed = JSON.parse(raw);
            if (!Array.isArray(parsed)) {
                return [];
            }
            return parsed;
        } catch (error) {
            console.warn('Failed to load pending ledger imports:', error);
            return [];
        }
    }

    function savePendingImportEntries(entries) {
        if (!window?.localStorage) {
            return;
        }
        try {
            window.localStorage.setItem(PENDING_IMPORT_STORAGE_KEY, JSON.stringify(entries.slice(0, 8)));
        } catch (error) {
            console.warn('Failed to persist pending ledger imports:', error);
        }
    }

    function addPendingImportEntry(entry) {
        const entries = loadPendingImportEntries().filter((item) => item.id !== entry.id && item.jobId !== entry.jobId);
        entries.unshift(entry);
        savePendingImportEntries(entries);
        return entries;
    }

    function deriveCaseName(doc) {
        if (!doc?.name) {
            return 'æ–°è¦æ¡ˆä»¶';
        }
        const stripped = doc.name.replace(/\.[^.]+$/, '');
        return stripped || doc.name;
    }

    const TAB_DEFINITIONS = [
        {
            id: 'real_estate',
            label: 'ä¸å‹•ç”£',
            description: 'åå¯„å¸³ãƒ»å›ºå®šè³‡ç”£è©•ä¾¡è¨¼æ˜æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åœŸåœ°ãƒ»å®¶å±‹æƒ…å ±ã‚’èª­ã¿å–ã‚Šã€JON APIã§ç™»è¨˜æƒ…å ±ãƒ»è·¯ç·šä¾¡å›³ç­‰ã‚’å–å¾—ã§ãã¾ã™ã€‚',
            docType: 'nayose',
            allowUpload: true,
            enableJonApi: true,
            recommendedModel: 'gemini_pro',
            locked: true,
            unlockPassword: 'IUProperty7520',
        },
        {
            id: 'securities',
            label: 'æœ‰ä¾¡è¨¼åˆ¸',
            description: 'ä¸Šå ´æ ªå¼ãƒ»æŠ•è³‡ä¿¡è¨—ãªã©ã®è©•ä¾¡ã¯é †æ¬¡å¯¾å¿œäºˆå®šã§ã™ã€‚',
            docType: 'unknown',
            allowUpload: false,
        },
        {
            id: 'deposits',
            label: 'é è²¯é‡‘',
            description: 'é è²¯é‡‘ã®è©³ç´°ç®¡ç†ã¯é€šå¸³ãƒ»å–å¼•å±¥æ­´ã‚¿ãƒ–ã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚',
            docType: 'unknown',
            allowUpload: false,
        },
        {
            id: 'insurance',
            label: 'ç”Ÿå‘½ä¿é™º',
            description: 'ç”Ÿå‘½ä¿é™ºè¨¼åˆ¸ã®è§£æã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚',
            docType: 'unknown',
            allowUpload: false,
        },
        {
            id: 'others',
            label: 'ãã®ä»–è²¡ç”£',
            description: 'ãã®ä»–ã®è²¡ç”£ç¨®åˆ¥ã«ã¤ã„ã¦ã¯ä»Šå¾Œè¿½åŠ äºˆå®šã§ã™ã€‚',
            docType: 'unknown',
            allowUpload: false,
        },
        {
            id: 'bank_documents',
            label: 'é€šå¸³ãƒ»å–å¼•å±¥æ­´',
            description: 'é è²¯é‡‘é€šå¸³ã‚„å–å¼•å±¥æ­´ã® PDF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ç”¨é€”ã«å¿œã˜ãŸèª­ã¿å–ã‚Šç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚',
            docType: 'transaction_history',
            allowUpload: true,
            allowDateFormat: true,
            docTypeOptions: [
                { value: 'transaction_history', label: 'å–å¼•å±¥æ­´' },
                { value: 'bank_deposit', label: 'é€šå¸³ï¼ˆé è²¯é‡‘ï¼‰' },
            ],
            recommendedModel: 'gemini_pro',
        },
    ];

    const DOC_TYPE_LABELS = {
        '': 'è‡ªå‹•åˆ¤å®š',
        bank_deposit: 'é€šå¸³ï¼ˆé è²¯é‡‘ï¼‰',
        transaction_history: 'å–å¼•å±¥æ­´',
        nayose: 'åå¯„å¸³ãƒ»å›ºå®šè³‡ç”£è©•ä¾¡è¨¼æ˜æ›¸',
        land: 'åœŸåœ°',
        building: 'å®¶å±‹',
        securities: 'æœ‰ä¾¡è¨¼åˆ¸',
        insurance: 'ç”Ÿå‘½ä¿é™º',
        others: 'ãã®ä»–è²¡ç”£',
        unknown: 'æœªåˆ†é¡',
    };

    const DATE_FORMAT_OPTIONS = [
        { value: 'auto', label: 'è‡ªå‹•åˆ¤å®š' },
        { value: 'western', label: 'è¥¿æš¦ (YYYY/MM/DD)' },
        { value: 'wareki', label: 'å’Œæš¦ (ä»¤å’Œ/å¹³æˆ)' },
    ];

    const DATE_FORMAT_LABELS = {
        auto: 'è‡ªå‹•åˆ¤å®š',
        western: 'è¥¿æš¦ (YYYY/MM/DD)',
        wareki: 'å’Œæš¦ (ä»¤å’Œ/å¹³æˆ)',
    };

    const ANALYSIS_MODE_OPTIONS = [
        { value: 'gemini_pro', label: 'Gemini 2.5 Proã€æ¨å¥¨ã€‘' },
        { value: 'gemini_flash', label: 'Gemini 2.5 Flashã€é«˜é€Ÿã€‘' },
    ];

    const ANALYSIS_MODE_LABELS = {
        gemini_flash: 'Gemini 2.5 Flashï¼ˆé«˜é€Ÿï¼‰',
        gemini_pro: 'Gemini 2.5 Proï¼ˆé«˜ç²¾åº¦ï¼‰',
    };

    init();

    function init() {
        const queryApi = new URLSearchParams(window.location.search).get('api');
        if (queryApi) {
            state.apiBase = queryApi.replace(/\/$/, '');
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªã‚¿ãƒ–ï¼ˆé€šå¸³ãƒ»å–å¼•å±¥æ­´ï¼‰
        const defaultTab = TAB_DEFINITIONS.find((tab) => tab.allowUpload && !tab.locked)
            || TAB_DEFINITIONS.find((tab) => tab.allowUpload)
            || TAB_DEFINITIONS[0];
        state.activeAssetTabId = defaultTab ? defaultTab.id : null;
        renderAssetTabs();
        setupRevealAnimations();
        loadLimits();
        setupNotificationButton();
        setupCancelButton();
        updateLedgerPendingMessage();
        statusBox.style.display = 'none';
        statusBox.classList.remove('visible');
    }

    function setupRevealAnimations() {
        const targets = [
            document.querySelector('header'),
            ...document.querySelectorAll('main section.card'),
            document.querySelector('footer'),
        ].filter(Boolean);

        targets.forEach((element, index) => {
            element.classList.add('pre-reveal');
            setTimeout(() => {
                element.classList.add('revealed');
                element.classList.remove('pre-reveal');
            }, 140 * index + 220);
        });
    }


    async function loadLimits() {
        try {
            const res = await fetch(`${normalizedApiBase()}/meta/limits`);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}`);
            }
            const data = await res.json();
            state.limits = data;
            updateUploadGuidance();
            renderAssetTabs();
        } catch (error) {
            console.warn('Failed to load limits', error);
            updateUploadGuidance(true);
        }
    }


    function updateUploadGuidance(fallback = false) {
        if (!uploadGuidance) return;
        if (fallback) {
            uploadGuidance.textContent =
                'PDFã®ã¿å¯¾å¿œï¼ˆ1å£åº§=1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã€‚é€šå¸¸ã¯1ãƒ•ã‚¡ã‚¤ãƒ«ã‚ãŸã‚Š20MBå‰å¾Œã¾ã§ã®PDFã‚’ç›®å®‰ã«ã—ã¦ãã ã•ã„ã€‚';
            return;
        }
        const limitMb = state.limits?.gemini?.document_max_mb;
        if (limitMb) {
            uploadGuidance.textContent = `PDFã®ã¿å¯¾å¿œï¼1å£åº§=1ãƒ•ã‚¡ã‚¤ãƒ«ã€‚Geminiã®ä¸Šé™ç›®å®‰ã¯1ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§ ${limitMb}MB ã§ã™ã€‚è¶…ãˆã‚‹å ´åˆã¯åˆ†å‰²ãƒ»åœ§ç¸®ã—ã¦ãã ã•ã„ã€‚`;
        } else {
            uploadGuidance.textContent = 'PDFã®ã¿å¯¾å¿œï¼ˆ1å£åº§=1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã€‚èª­ã¿å–ã‚Šå¯èƒ½ã‚µã‚¤ã‚ºã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦';
        }
    }


    function setupNotificationButton() {
        if (!notificationButton) {
            return;
        }
        if (!('Notification' in window)) {
            notificationButton.style.display = 'none';
            return;
        }
        notificationButton.addEventListener('click', handleNotificationRequest);
        if (Notification.permission === 'granted') {
            state.notificationsEnabled = true;
        }
        updateNotificationButton();
    }


    async function handleNotificationRequest() {
        const granted = await ensureNotificationPermission();
        state.notificationsEnabled = granted;
        updateNotificationButton();
        if (granted) {
            setStatus('æ¬¡å›ä»¥é™ã€èª­ã¿å–ã‚Šå®Œäº†æ™‚ã«é€šçŸ¥ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚', 'success');
        } else if (Notification.permission === 'denied') {
            setStatus('é€šçŸ¥ã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚', 'error');
        } else {
            setStatus('é€šçŸ¥ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
        }
    }


    async function ensureNotificationPermission() {
        if (!('Notification' in window)) {
            return false;
        }
        if (Notification.permission === 'granted') {
            return true;
        }
        if (Notification.permission === 'denied') {
            return false;
        }
        try {
            const result = await Notification.requestPermission();
            return result === 'granted';
        } catch (error) {
            console.warn('Notification permission request failed', error);
            return false;
        }
    }


    function updateNotificationButton() {
        if (!notificationButton || !('Notification' in window)) return;
        const permission = Notification.permission;
        if (permission === 'granted') {
            notificationButton.textContent = 'é€šçŸ¥ã¯æœ‰åŠ¹ã§ã™';
            notificationButton.disabled = true;
        } else if (permission === 'denied') {
            notificationButton.textContent = 'é€šçŸ¥ã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™';
            notificationButton.disabled = true;
        } else {
            notificationButton.textContent = 'èª­ã¿å–ã‚Šå®Œäº†ã‚’é€šçŸ¥';
            notificationButton.disabled = false;
        }
    }


    function setupCancelButton() {
        if (!cancelButton) return;
        cancelButton.addEventListener('click', cancelProcessing);
        updateCancelButton();
    }


    function updateCancelButton() {
        if (!cancelRow || !cancelButton) return;
        if (state.isProcessing) {
            cancelRow.style.display = 'block';
            cancelButton.disabled = false;
        } else {
            cancelRow.style.display = 'none';
        }
    }


    function renderAssetTabs() {
        assetTabsRoot.innerHTML = '';
        if (!TAB_DEFINITIONS.length) {
            return;
        }

        if (!state.activeAssetTabId) {
            const defaultTab = TAB_DEFINITIONS.find((tab) => tab.allowUpload && !tab.locked)
                || TAB_DEFINITIONS.find((tab) => tab.allowUpload)
                || TAB_DEFINITIONS[0];
            state.activeAssetTabId = defaultTab ? defaultTab.id : null;
        }

        const layout = document.createElement('div');
        layout.className = 'asset-layout';

        const nav = document.createElement('nav');
        nav.className = 'asset-nav';

        const panelsWrapper = document.createElement('div');
        panelsWrapper.className = 'asset-panels';

        TAB_DEFINITIONS.forEach((tab) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'asset-nav-button';
            button.dataset.tabId = tab.id;
            button.setAttribute('aria-disabled', tab.allowUpload ? 'false' : 'true');

            const labelSpan = document.createElement('span');
            labelSpan.textContent = tab.label;
            button.appendChild(labelSpan);
            button.title = tab.description || tab.label;

            if (!tab.allowUpload) {
                const coming = document.createElement('span');
                coming.className = 'coming';
                coming.textContent = 'æº–å‚™ä¸­';
                button.appendChild(coming);
            } else if (tab.locked) {
                const lockIcon = document.createElement('span');
                lockIcon.className = 'lock-icon';
                lockIcon.textContent = 'ğŸ”’';
                lockIcon.title = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã•ã‚Œã¦ã„ã¾ã™';
                button.appendChild(lockIcon);
            }

            button.addEventListener('click', () => setActiveAssetTab(tab.id));
            nav.appendChild(button);

            const panel = document.createElement('div');
            panel.className = 'asset-panel';
            panel.dataset.tabId = tab.id;

            const heading = document.createElement('h3');
            heading.textContent = `${tab.label}ã®èª­ã¿å–ã‚Š`;
            panel.appendChild(heading);

            const description = document.createElement('p');
            description.className = 'panel-description';
            description.textContent = tab.description || 'é †æ¬¡å¯¾å¿œäºˆå®šã§ã™ã€‚';
            panel.appendChild(description);

            if (tab.allowUpload) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'file';
                hiddenInput.accept = 'application/pdf';
                hiddenInput.multiple = true;
                hiddenInput.style.display = 'none';
                panel.appendChild(hiddenInput);

                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'asset-panel-controls';

                let selectedDocType = (tab.docTypeOptions && tab.docTypeOptions[0]?.value) || tab.docType || 'bank_deposit';
                const getDocType = () => selectedDocType;

                if (Array.isArray(tab.docTypeOptions) && tab.docTypeOptions.length) {
                    const toggle = document.createElement('div');
                    toggle.className = 'doc-type-toggle';
                    tab.docTypeOptions.forEach((option) => {
                        const optBtn = document.createElement('button');
                        optBtn.type = 'button';
                        optBtn.className = 'doc-type-option';
                        optBtn.textContent = option.label;
                        if (option.value === selectedDocType) {
                            optBtn.classList.add('active');
                        }
                        optBtn.addEventListener('click', () => {
                            selectedDocType = option.value;
                            toggle.querySelectorAll('.doc-type-option').forEach((btn) => btn.classList.remove('active'));
                            optBtn.classList.add('active');
                            updateDropCopy();
                        });
                        toggle.appendChild(optBtn);
                    });
                    controlsContainer.appendChild(toggle);
                }

                let dateSelect = null;
                if (tab.allowDateFormat) {
                    const dateControls = document.createElement('div');
                    dateControls.className = 'input-row';

                    const dateLabel = document.createElement('label');
                    dateLabel.style.fontSize = '0.9rem';
                    dateLabel.style.color = '#1f3b8c';
                    dateLabel.textContent = 'æ—¥ä»˜ã®èª­ã¿å–ã‚Šå½¢å¼';
                    dateControls.appendChild(dateLabel);

                    dateSelect = document.createElement('select');
                    dateSelect.className = 'text-input';
                    DATE_FORMAT_OPTIONS.forEach((option) => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        dateSelect.appendChild(opt);
                    });
                    dateSelect.value = 'auto';
                    dateControls.appendChild(dateSelect);

                    controlsContainer.appendChild(dateControls);

                    // èª­å–é–‹å§‹æ—¥ã®å…¥åŠ›æ¬„
                    const startDateControls = document.createElement('div');
                    startDateControls.className = 'input-row';

                    const startDateLabel = document.createElement('label');
                    startDateLabel.style.fontSize = '0.9rem';
                    startDateLabel.style.color = '#1f3b8c';
                    startDateLabel.textContent = 'èª­å–é–‹å§‹æ—¥ï¼ˆä»»æ„ï¼‰';
                    startDateControls.appendChild(startDateLabel);

                    const startDateInput = document.createElement('input');
                    startDateInput.type = 'date';
                    startDateInput.className = 'text-input start-date-input';
                    startDateInput.style.width = '180px';
                    startDateInput.placeholder = 'YYYY-MM-DD';
                    startDateControls.appendChild(startDateInput);

                    const startDateHint = document.createElement('span');
                    startDateHint.style.fontSize = '0.8rem';
                    startDateHint.style.color = '#6b7280';
                    startDateHint.textContent = 'ã“ã®æ—¥ä»¥é™ã®å–å¼•ã‚’èª­ã¿è¾¼ã¿';
                    startDateControls.appendChild(startDateHint);

                    controlsContainer.appendChild(startDateControls);

                    // èª­å–çµ‚äº†æ—¥ã®å…¥åŠ›æ¬„
                    const endDateControls = document.createElement('div');
                    endDateControls.className = 'input-row';

                    const endDateLabel = document.createElement('label');
                    endDateLabel.style.fontSize = '0.9rem';
                    endDateLabel.style.color = '#1f3b8c';
                    endDateLabel.textContent = 'èª­å–çµ‚äº†æ—¥ï¼ˆä»»æ„ï¼‰';
                    endDateControls.appendChild(endDateLabel);

                    const endDateInput = document.createElement('input');
                    endDateInput.type = 'date';
                    endDateInput.className = 'text-input end-date-input';
                    endDateInput.style.width = '180px';
                    endDateInput.placeholder = 'YYYY-MM-DD';
                    endDateControls.appendChild(endDateInput);

                    const endDateHint = document.createElement('span');
                    endDateHint.style.fontSize = '0.8rem';
                    endDateHint.style.color = '#6b7280';
                    endDateHint.textContent = 'ç©ºæ¬„ï¼æœ€æ–°ã¾ã§';
                    endDateControls.appendChild(endDateHint);

                    controlsContainer.appendChild(endDateControls);
                }

                // æ—¥ä»˜å…¥åŠ›ã®ã‚²ãƒƒã‚¿ãƒ¼
                const getStartDate = () => {
                    const input = controlsContainer.querySelector('.start-date-input');
                    return input ? input.value : '';
                };
                const getEndDate = () => {
                    const input = controlsContainer.querySelector('.end-date-input');
                    return input ? input.value : '';
                };

                const modeControls = document.createElement('div');
                modeControls.className = 'input-row';

                const modeLabel = document.createElement('label');
                modeLabel.style.fontSize = '0.9rem';
                modeLabel.style.color = '#1f3b8c';
                modeLabel.textContent = 'è§£æã‚¨ãƒ³ã‚¸ãƒ³';
                modeControls.appendChild(modeLabel);

                const modeSelect = document.createElement('select');
                modeSelect.className = 'text-input';
                modeSelect.id = 'analysisModeSelect';
                ANALYSIS_MODE_OPTIONS.forEach((option) => {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    modeSelect.appendChild(opt);
                });
                // Set initial value based on THIS tab's recommended model (not the active tab)
                const initialModel = tab.recommendedModel || 'gemini_pro';
                modeSelect.value = initialModel;
                modeSelect.addEventListener('change', () => {
                    state.analysisMode = modeSelect.value || 'gemini_pro';
                });
                modeControls.appendChild(modeSelect);

                const modeHint = document.createElement('span');
                modeHint.style.fontSize = '0.8rem';
                modeHint.style.color = '#6b7280';
                modeHint.textContent = 'Gemini 2.5 Pro/Flash ã®ã©ã¡ã‚‰ã‹ã§èª­ã¿å–ã‚Šã¾ã™ã€‚ç”¨é€”ã«å¿œã˜ã¦ç²¾åº¦ã‹é€Ÿåº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                modeControls.appendChild(modeHint);

                controlsContainer.appendChild(modeControls);

                const uploadRow = document.createElement('div');
                uploadRow.className = 'input-row';

                const uploadButton = document.createElement('button');
                uploadButton.type = 'button';
                uploadButton.className = 'primary';
                uploadButton.textContent = 'PDF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
                uploadButton.addEventListener('click', () => hiddenInput.click());
                uploadRow.appendChild(uploadButton);

                const hint = document.createElement('span');
                hint.style.fontSize = '0.85rem';
                hint.style.color = '#4b5563';
                hint.textContent = 'è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€æ‹¬èª­ã¿å–ã‚Šã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚';
                uploadRow.appendChild(hint);

                controlsContainer.appendChild(uploadRow);
                panel.appendChild(controlsContainer);

                const dropArea = document.createElement('div');
                dropArea.className = 'drop-area';
                const dropTitle = document.createElement('strong');
                dropTitle.textContent = 'ã“ã“ã« PDF ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—';
                const dropMessage = document.createElement('p');
                dropArea.appendChild(dropTitle);
                dropArea.appendChild(dropMessage);
                panel.appendChild(dropArea);

                function updateDropCopy() {
                    const labelText = describeDocType(selectedDocType);
                    dropMessage.textContent = buildDropMessage(labelText);
                }
                updateDropCopy();

                dropArea.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    dropArea.classList.add('active');
                });
                dropArea.addEventListener('dragleave', () => dropArea.classList.remove('active'));
                dropArea.addEventListener('drop', (event) => {
                    event.preventDefault();
                    dropArea.classList.remove('active');
                    if (event.dataTransfer.files && event.dataTransfer.files.length) {
                        handleTabFiles(
                            tab,
                            event.dataTransfer.files,
                            () => dateSelect?.value || 'auto',
                            getDocType,
                            getStartDate,
                            getEndDate
                        );
                    }
                });

                hiddenInput.addEventListener('change', (event) => {
                    if (event.target.files && event.target.files.length) {
                        handleTabFiles(tab, event.target.files, () => dateSelect?.value || 'auto', getDocType, getStartDate, getEndDate);
                        hiddenInput.value = '';
                    }
                });
            } else {
                const notice = document.createElement('p');
                notice.className = 'coming-soon';
                notice.textContent = tab.description || 'è¿‘æ—¥å¯¾å¿œäºˆå®šã§ã™ã€‚';
                panel.appendChild(notice);
            }

            panelsWrapper.appendChild(panel);
        });

        layout.appendChild(nav);
        layout.appendChild(panelsWrapper);
        assetTabsRoot.appendChild(layout);

        const fallbackTabId = state.activeAssetTabId || (TAB_DEFINITIONS[0] && TAB_DEFINITIONS[0].id);
        setActiveAssetTab(fallbackTabId, true);  // åˆæœŸåŒ–æ™‚ã¯ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—
    }

    function checkTabLock(tabId) {
        const tab = TAB_DEFINITIONS.find(t => t.id === tabId);
        if (!tab || !tab.locked) return true;
        if (state.unlockedTabs.has(tabId)) return true;

        const password = prompt('ã“ã®ã‚¿ãƒ–ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (password === tab.unlockPassword) {
            state.unlockedTabs.add(tabId);
            return true;
        } else if (password !== null) {
            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
        }
        return false;
    }

    function setActiveAssetTab(tabId, skipLockCheck = false) {
        // ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼ˆskipLockCheck=trueã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
        if (!skipLockCheck && !checkTabLock(tabId)) {
            return;
        }

        state.activeAssetTabId = tabId;
        const buttons = assetTabsRoot.querySelectorAll('.asset-nav-button');
        buttons.forEach((button) => {
            const isActive = button.dataset.tabId === tabId;
            button.classList.toggle('active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
        const panels = assetTabsRoot.querySelectorAll('.asset-panel');
        panels.forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.tabId === tabId);
        });

        // Switch Gemini model based on tab's recommended model
        const tab = TAB_DEFINITIONS.find(t => t.id === tabId);
        if (tab?.recommendedModel) {
            // Find modeSelect within the active panel (each panel has its own modeSelect)
            const activePanel = assetTabsRoot.querySelector(`.asset-panel[data-tab-id="${tabId}"]`);
            const modeSelect = activePanel?.querySelector('#analysisModeSelect');
            if (modeSelect) {
                modeSelect.value = tab.recommendedModel;
                state.analysisMode = tab.recommendedModel;
            }
        }
    }

    function handleTabFiles(tab, fileList, getDateFormat, getDocType, getStartDate, getEndDate) {
        processFiles(fileList, {
            tabId: tab.id,
            label: tab.label,
            docType: tab.docType,
            getDocType,
            dateFormat: getDateFormat ? getDateFormat() : 'auto',
            startDate: getStartDate ? getStartDate() : '',
            endDate: getEndDate ? getEndDate() : '',
            getProcessingConfig: () => getProcessingModeConfig(),
        });
    }

    async function processFiles(fileList, tabConfig = {}) {
        if (state.isProcessing) {
            setStatus('åˆ¥ã®èª­ã¿å–ã‚ŠãŒé€²è¡Œä¸­ã§ã™ã€‚ä¸­æ­¢ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            return;
        }
        const files = Array.from(fileList || []).filter((file) => {
            if (!file) return false;
            if (file.type === 'application/pdf') return true;
            return (file.name || '').toLowerCase().endsWith('.pdf');
        });
        if (!files.length) {
            setStatus('PDF ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
            return;
        }

        const docTypeGetter = typeof tabConfig.getDocType === 'function'
            ? tabConfig.getDocType
            : () => tabConfig.docType || '';
        const processingConfigGetter = typeof tabConfig.getProcessingConfig === 'function'
            ? tabConfig.getProcessingConfig
            : () => getProcessingModeConfig();
        const label = tabConfig.label || '';
        const dateFormat = normalizeDateFormat(tabConfig.dateFormat);
        const startDate = tabConfig.startDate || '';
        const endDate = tabConfig.endDate || '';
        const initialDocType = docTypeGetter() || '';
        const docTypeLabel = describeDocType(initialDocType);
        const prefixParts = [];
        if (label) {
            prefixParts.push(label);
        }
        if (docTypeLabel && docTypeLabel !== DOC_TYPE_LABELS['']) {
            prefixParts.push(docTypeLabel);
        }
        const prefix = prefixParts.length ? `${prefixParts.join(' / ')}ã®` : '';

        setStatus(`${prefix}${files.length} ä»¶ã®èª­ã¿å–ã‚Šã‚’é–‹å§‹ã—ã¾ã™â€¦`, 'info');

        state.isProcessing = true;
        state.cancelRequested = false;
        updateCancelButton();

        for (let index = 0; index < files.length; index += 1) {
            const file = files[index];
            const currentDocType = docTypeGetter() || '';
            if (state.cancelRequested) {
                setStatus('èª­ã¿å–ã‚Šã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚', 'error');
                break;
            }
            try {
                const processingConfig = processingConfigGetter() || {};
                const doc = await handleSingleFile(file, currentDocType, dateFormat, processingConfig, startDate, endDate);
                state.documents.push(doc);
                state.activeDocId = doc.id;
                notifyCompletion(doc);
                if (Array.isArray(doc.assets) && doc.assets.length) {
                    state.pendingImportCount = addPendingImportEntry({
                        id: doc.id,
                        jobId: doc.jobId,
                        name: doc.name,
                        createdAt: new Date().toISOString(),
                        assets: doc.assets,
                    }).length;
                    updateLedgerPendingMessage();
                }
                setStatus(`(${index + 1}/${files.length}) ã€Œ${file.name}ã€ã®èª­ã¿å–ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸã€‚`, 'info');
            } catch (error) {
                if (state.cancelRequested || error?.name === 'AbortError') {
                    setStatus('èª­ã¿å–ã‚Šã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚', 'error');
                    break;
                }
                console.error(error);
                state.documents.push({
                    id: createDocId(),
                    name: file.name,
                    docType: currentDocType,
                    dateFormat,
                    error: error.message || 'èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
                });
                setStatus(`(${index + 1}/${files.length}) ã€Œ${file.name}ã€ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚`, 'error');
            }
        }

        const wasCancelled = state.cancelRequested;
        state.isProcessing = false;
        state.currentAbortController = null;
        updateCancelButton();
        state.cancelRequested = false;

        renderDocuments();
        renderDownloads();
        renderRawJson();
        scrollToResults();

        if (wasCancelled) {
            setStatus('èª­ã¿å–ã‚Šã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚', 'error');
            return;
        }

        const hasError = state.documents.some((doc) => doc.error);
        setStatus(
            hasError
                ? 'ä¸€éƒ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å„ã‚¿ãƒ–ã‹ã‚‰è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'
                : 'ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚',
            hasError ? 'error' : 'success'
        );
    }

    async function handleSingleFile(file, docType, dateFormat, processingConfig = {}, startDate = '', endDate = '') {
        setStatus(`ã€Œ${file.name}ã€ã®è§£æã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™â€¦`, 'info');
        const startedAt = performance.now();
        const jobId = await enqueueJob(file, docType, dateFormat, processingConfig, startDate, endDate);
        const result = await pollJobUntilComplete(jobId, { fileName: file.name });
        const assets = Array.isArray(result.assets) ? result.assets : [];
        if (!assets.length) {
            throw new Error('å–å¼•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
        const durationSeconds = Math.max(0, (performance.now() - startedAt) / 1000);
        state.latestJobId = jobId;
        return {
            id: createDocId(),
            name: file.name,
            docType: docType || result.documentType || result.document_type,
            dateFormat,
            assets,
            csvFiles: result.files,
            jobId,
            durationSeconds,
        };
    }

    async function enqueueJob(file, docType, dateFormat, processingConfig = {}, startDate = '', endDate = '') {
        const base = normalizedApiBase();
        const form = new FormData();
        form.append('file', file);
        if (docType) {
            form.append('document_type', docType);
        }
        if (dateFormat) {
            form.append('date_format', normalizeDateFormat(dateFormat));
        }
        if (processingConfig && processingConfig.processing_mode) {
            form.append('processing_mode', processingConfig.processing_mode);
        }
        if (processingConfig && processingConfig.gemini_model) {
            form.append('gemini_model', processingConfig.gemini_model);
        }
        if (startDate) {
            form.append('start_date', startDate);
        }
        if (endDate) {
            form.append('end_date', endDate);
        }
        const res = await fetchWithAbort(`${base}/jobs`, {
            method: 'POST',
            body: form,
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(`ã‚¸ãƒ§ãƒ–ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (HTTP ${res.status}): ${text}`);
        }
        const payload = await res.json();
        if (payload.status !== 'accepted' || !payload.job_id) {
            throw new Error('ã‚¸ãƒ§ãƒ–ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
        return payload.job_id;
    }

    async function pollJobUntilComplete(jobId, { fileName } = {}) {
        const base = normalizedApiBase();
        let attempt = 0;
        while (true) {
            if (state.cancelRequested) {
                throw new Error('èª­ã¿å–ã‚Šã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚');
            }
            const res = await fetchWithAbort(`${base}/jobs/${jobId}`);
            if (res.status === 404) {
                throw new Error('ã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`ã‚¸ãƒ§ãƒ–çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${res.status}): ${text}`);
            }
            const statusPayload = await res.json();
            updateJobStatusMessage(statusPayload, fileName);
            if (statusPayload.status === 'failed') {
                throw new Error(statusPayload.detail || 'ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            if (statusPayload.status === 'completed') {
                const resultRes = await fetchWithAbort(`${base}/jobs/${jobId}/result?format=csv`);
                if (!resultRes.ok) {
                    const text = await resultRes.text();
                    throw new Error(`ã‚¸ãƒ§ãƒ–çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${resultRes.status}): ${text}`);
                }
                const resultPayload = await resultRes.json();
                return {
                    files: resultPayload.files || statusPayload.files || {},
                    assets: resultPayload.assets || [],
                    documentType: resultPayload.document_type || statusPayload.document_type,
                };
            }
            attempt += 1;
            const waitMs = Math.min(7000, 2000 + attempt * 400);
            await sleep(waitMs);
        }
    }

    function renderDocuments() {
        if (!state.documents.length) {
            resultsSection.style.display = 'none';
            tabContainer.style.display = 'none';
            tabEmptyMessage.style.display = 'block';
            return;
        }

        resultsSection.style.display = 'block';
        tabEmptyMessage.style.display = 'none';
        tabContainer.style.display = 'flex';
        tabHeaders.innerHTML = '';
        tabPanels.innerHTML = '';

        state.documents.forEach((doc) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.dataset.docId = doc.id;
            const labelParts = [doc.name];
            if (doc.docType) {
                labelParts.push(describeDocType(doc.docType));
            }
            if (doc.dateFormat) {
                labelParts.push(describeDateFormat(doc.dateFormat));
            }
            button.textContent = labelParts.join(' / ');
            button.addEventListener('click', () => setActiveDoc(doc.id));
            tabHeaders.appendChild(button);

            const panel = document.createElement('div');
            panel.className = 'tab-panel';
            panel.dataset.docId = doc.id;
            panel.appendChild(buildDocumentPanel(doc));
            tabPanels.appendChild(panel);
        });

        const defaultId =
            state.activeDocId && state.documents.some((doc) => doc.id === state.activeDocId)
                ? state.activeDocId
                : state.documents[state.documents.length - 1].id;
        setActiveDoc(defaultId);
    }

    function buildDocumentPanel(doc) {
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '1.2rem';

        if (doc.error) {
            const alert = document.createElement('div');
            alert.className = 'status error';
            alert.style.display = 'block';
            alert.textContent = doc.error;
            container.appendChild(alert);
            return container;
        }

        // For nayose documents, show different summary and Handsontable
        if (doc.docType === 'nayose' && Array.isArray(doc.assets)) {
            const summaryList = document.createElement('div');
            summaryList.className = 'summary-list';
            computeNayoseSummaryItems(doc).forEach((item) => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${item.label}</strong><div style="margin-top:0.4rem;">${escapeHtml(item.value)}</div>`;
                summaryList.appendChild(div);
            });
            container.appendChild(summaryList);

            // Use Handsontable for editable property list
            renderNayoseHandsontable(doc.assets, container);

            // Always render JON API panel with checkboxes, check status for execution
            checkJonApiStatus().then(status => {
                handleNayoseResultsForJon(doc.assets, container, status.configured, status.has_touki_credentials);
            }).catch(() => {
                // If status check fails, still show the panel but disabled
                handleNayoseResultsForJon(doc.assets, container, false, false);
            });
        } else {
            const summaryList = document.createElement('div');
            summaryList.className = 'summary-list';
            computeSummaryItems(doc).forEach((item) => {
                const div = document.createElement('div');
                div.innerHTML = `<strong>${item.label}</strong><div style="margin-top:0.4rem;">${escapeHtml(item.value)}</div>`;
                summaryList.appendChild(div);
            });
            container.appendChild(summaryList);

            const previewTable = buildPreviewTable(doc.assets);
            if (previewTable) {
                container.appendChild(previewTable);
            } else {
                const note = document.createElement('p');
                note.style.margin = '0';
                note.style.color = '#4b5563';
                note.textContent = 'è¡¨ç¤ºã§ãã‚‹å–å¼•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                container.appendChild(note);
            }
        }

        return container;
    }

    function computeNayoseSummaryItems(doc) {
        const assets = Array.isArray(doc.assets) ? doc.assets : [];
        const landCount = assets.filter(a => a.category === 'land').length;
        const buildingCount = assets.filter(a => a.category === 'building').length;
        const durationValue =
            typeof doc.durationSeconds === 'number'
                ? `${doc.durationSeconds.toFixed(1)} ç§’`
                : 'è¨ˆæ¸¬ä¸­';

        return [
            { label: 'å‡¦ç†æ™‚é–“', value: durationValue },
            { label: 'è³‡æ–™ç¨®åˆ¥', value: describeDocType(doc.docType) },
            { label: 'åœŸåœ°', value: `${landCount} ç­†` },
            { label: 'å®¶å±‹', value: `${buildingCount} æ£Ÿ` },
        ];
    }

    function renderNayoseHandsontable(assets, container) {
        const assetList = Array.isArray(assets) ? assets : [];
        const properties = assetList.filter(a => a.category === 'land' || a.category === 'building');

        if (!properties.length) {
            const note = document.createElement('p');
            note.style.margin = '0';
            note.style.color = '#4b5563';
            note.textContent = 'ä¸å‹•ç”£ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            container.appendChild(note);
            return;
        }

        // Parse notes to extract land_type/structure and area
        // Debug: log first property to see field names
        if (properties.length > 0) {
            console.log('First property keys:', Object.keys(properties[0]));
            console.log('First property:', JSON.stringify(properties[0], null, 2));
        }

        const data = properties.map((prop, idx) => {
            const notes = prop.notes || '';
            let landType = '';
            let area = '';

            // Extract from notes: "èª²ç¨åœ°ç›®: å®…åœ°" or "æ§‹é€ : æœ¨é€ ç“¦è‘º2éšå»º"
            const landTypeMatch = notes.match(/èª²ç¨åœ°ç›®:\s*([^\n]+)/);
            const structureMatch = notes.match(/æ§‹é€ :\s*([^\n]+)/);
            const areaMatch = notes.match(/(?:åœ°ç©|åºŠé¢ç©):\s*([0-9,.]+)/);

            if (landTypeMatch) landType = landTypeMatch[1].trim();
            else if (structureMatch) landType = structureMatch[1].trim();

            if (areaMatch) area = areaMatch[1].trim();

            // Handle nested structure from to_export_payload() and fallback to flat names
            const municipality = prop.location?.municipality || prop.location_municipality || prop.locationMunicipality || '';
            const location = prop.location?.detail || prop.location_detail || prop.locationDetail || '';
            const identifierPrimary = prop.identifiers?.primary || prop.identifier_primary || prop.identifierPrimary || '';
            const valuationAmount = prop.valuation?.amount ?? prop.valuation_amount ?? prop.valuationAmount ?? null;

            return {
                category: prop.category === 'building' ? 'å®¶å±‹' : 'åœŸåœ°',
                municipality: municipality,
                location: location,
                landType: landType,
                area: area,
                value: valuationAmount ? formatNumber(valuationAmount) : '',
                id: identifierPrimary || `prop-${idx}`,
            };
        });

        const hotWrapper = document.createElement('div');
        hotWrapper.className = 'handsontable-wrapper';
        hotWrapper.id = `nayoseHot-${Date.now()}`;
        container.appendChild(hotWrapper);

        // Initialize Handsontable after DOM is ready
        setTimeout(() => {
            if (typeof Handsontable === 'undefined') {
                console.warn('Handsontable not loaded');
                return;
            }
            jonState.hotInstance = new Handsontable(hotWrapper, {
                data: data,
                colHeaders: ['ç¨®åˆ¥', 'å¸‚åŒºç”ºæ‘', 'æ‰€åœ¨åœ°ãƒ»åœ°ç•ª', 'åœ°ç›®/æ§‹é€ ', 'åœ°ç©/åºŠé¢ç©', 'è©•ä¾¡é¡'],
                columns: [
                    { data: 'category', type: 'dropdown', source: ['åœŸåœ°', 'å®¶å±‹'], width: 60 },
                    { data: 'municipality', type: 'text', width: 100 },
                    { data: 'location', type: 'text', width: 200 },
                    { data: 'landType', type: 'text', width: 100 },
                    { data: 'area', type: 'text', width: 80 },
                    { data: 'value', type: 'text', width: 100 },
                ],
                rowHeaders: true,
                height: 'auto',
                maxRows: 100,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                contextMenu: true,
                manualColumnResize: true,
            });
        }, 100);
    }

    function computeSummaryItems(doc) {
        const assets = Array.isArray(doc.assets) ? doc.assets : [];
        const owners = new Set();
        const accounts = new Set();
        let totalTransactions = 0;
        let latestBalance = null;

        assets.forEach((asset) => {
            const ownerValues = Array.isArray(asset.owner_name)
                ? asset.owner_name
                : asset?.owner_name
                ? [asset.owner_name]
                : [];
            ownerValues
                .map((name) => (name || '').toString().trim())
                .filter(Boolean)
                .forEach((name) => owners.add(name));

            if (asset.identifier_primary) {
                accounts.add(asset.identifier_primary);
            }

            const transactions = Array.isArray(asset.transactions) ? asset.transactions : [];
            transactions.forEach((txn) => {
                totalTransactions += 1;
                if (txn && txn.balance !== undefined && txn.balance !== null && txn.balance !== '') {
                    latestBalance = txn.balance;
                }
            });
        });

        const formattedBalance = latestBalance !== null ? formatNumber(latestBalance) : '';
        const durationValue =
            typeof doc.durationSeconds === 'number'
                ? `${doc.durationSeconds.toFixed(1)} ç§’`
                : 'è¨ˆæ¸¬ä¸­';

        return [
            { label: 'å‡¦ç†æ™‚é–“', value: durationValue },
            { label: 'è³‡æ–™ç¨®åˆ¥', value: describeDocType(doc.docType) },
            { label: 'åç¾©äºº', value: owners.size ? Array.from(owners).join('ã€') : 'æœªæ¤œå‡º' },
            { label: 'å£åº§ç•ªå·', value: accounts.size ? Array.from(accounts).join('ã€') : 'æœªæ¤œå‡º' },
            { label: 'å–å¼•ä»¶æ•°', value: `${totalTransactions} ä»¶` },
            { label: 'æœ€çµ‚æ®‹é«˜', value: formattedBalance ? `${formattedBalance} å††` : 'æœªæ¤œå‡º' },
            { label: 'æ—¥ä»˜å½¢å¼', value: describeDateFormat(doc.dateFormat) },
        ];
    }

    function buildPreviewTable(assets) {
        const assetList = Array.isArray(assets) ? assets : [];
        const firstAssetWithTransactions = assetList.find(
            (asset) => Array.isArray(asset.transactions) && asset.transactions.length
        );
        const transactions = firstAssetWithTransactions?.transactions?.slice(0, 12) || [];
        if (!transactions.length) {
            return null;
        }
        const columns = [
            { key: 'transaction_date', label: 'å–å¼•æ—¥', type: 'text' },
            { key: 'description', label: 'æ‘˜è¦', type: 'text' },
            { key: 'withdrawal_amount', label: 'å‡ºé‡‘', type: 'number' },
            { key: 'deposit_amount', label: 'å…¥é‡‘', type: 'number' },
            { key: 'balance', label: 'æ®‹é«˜', type: 'number' },
            { key: 'correction_note', label: 'è£œæ­£ãƒ¡ãƒ¢', type: 'text' },
        ];

        const table = document.createElement('table');
        table.className = 'preview';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        columns.forEach((col) => {
            const th = document.createElement('th');
            th.textContent = col.label;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        transactions.forEach((txn) => {
            const row = document.createElement('tr');
            columns.forEach((col) => {
                const cell = document.createElement('td');
                const value = txn?.[col.key];
                if (col.type === 'number') {
                    cell.textContent = formatNumber(value);
                } else {
                    cell.textContent = escapeHtml(value || '');
                }
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        return table;
    }

    function setActiveDoc(docId) {
        state.activeDocId = docId;
        Array.from(tabHeaders.children).forEach((button) => {
            button.classList.toggle('active', button.dataset.docId === docId);
        });
        Array.from(tabPanels.children).forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.docId === docId);
        });
    }

    function renderDownloads() {
        downloadList.innerHTML = '';
        state.documents.forEach((doc) => {
            if (doc.error || !doc.csvFiles) {
                return;
            }
            Object.entries(doc.csvFiles).forEach(([filename, base64]) => {
                const card = document.createElement('div');
                card.className = 'download-card';
                card.innerHTML = `
                    <h3>${escapeHtml(doc.name)} - ${escapeHtml(filename)}</h3>
                    <p style="margin:0;font-size:0.85rem;color:#4b5563;">èª­ã¿å–ã‚Šçµæœã‚’ CSV ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</p>
                    <p style="margin:0;font-size:0.8rem;color:#6b7280;">è³‡æ–™ç¨®åˆ¥: ${escapeHtml(describeDocType(doc.docType))} ï¼ æ—¥ä»˜å½¢å¼: ${escapeHtml(describeDateFormat(doc.dateFormat))}</p>
                `;
                const button = document.createElement('button');
                button.className = 'primary small';
                button.textContent = 'èª­ã¿å–ã‚Šçµæœã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
                button.addEventListener('click', () => downloadCsv(`${doc.name}-${filename}`, base64));
                card.appendChild(button);
                downloadList.appendChild(card);
            });
        });
        const hasDownloads = downloadList.childElementCount > 0;
        downloadSection.style.display = hasDownloads ? 'block' : 'none';
        if (ledgerShortcut) {
            ledgerShortcut.style.display = hasDownloads ? 'flex' : 'none';
            if (hasDownloads && openLedgerButton) {
                const ledgerUrl = buildLedgerUrl(state.latestJobId);
                openLedgerButton.onclick = () => window.open(ledgerUrl, '_blank', 'noopener');
            }
        }
        updateLedgerPendingMessage();
    }

    function renderRawJson() {
        if (!state.documents.length) {
            rawJson.textContent = '';
            return;
        }
        const payload = state.documents.map((doc) =>
            doc.error
                ? {
                      name: doc.name,
                      error: doc.error,
                      documentType: doc.docType,
                      dateFormat: doc.dateFormat,
                  }
                : {
                      name: doc.name,
                      documentType: doc.docType,
                      dateFormat: doc.dateFormat,
                      assets: doc.assets,
                  }
        );
        rawJson.textContent = JSON.stringify(payload, null, 2);
    }

    function downloadCsv(filename, base64) {
        const text = decodeBase64(base64);
        const blob = new Blob(['ï»¿' + text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function cancelProcessing() {
        state.cancelRequested = true;
        if (state.currentAbortController) {
            try {
                state.currentAbortController.abort();
            } catch (error) {
                console.warn('Abort failed', error);
            }
        }
        setStatus('èª­ã¿å–ã‚Šã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚', 'error');
    }

    function scrollToResults() {
        if (state.documents.length && resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    function decodeBase64(base64) {
        const binary = atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
            bytes[i] = binary.charCodeAt(i);
        }
        let text = new TextDecoder('utf-8').decode(bytes);
        if (text.charCodeAt(0) === 0xfeff) {
            text = text.slice(1);
        }
        return text;
    }

    function notifyCompletion(doc) {
        if (!state.notificationsEnabled) {
            return;
        }
        const transactionCount = doc.assets?.[0]?.transactions?.length || 0;
        const body = transactionCount
            ? `${doc.name} ã®èª­ã¿å–ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆå–å¼• ${transactionCount} ä»¶ï¼‰`
            : `${doc.name} ã®èª­ã¿å–ã‚ŠãŒå®Œäº†ã—ã¾ã—ãŸã€‚`;
        try {
            new Notification('SOROBOCR èª­ã¿å–ã‚Šå®Œäº†', { body });
        } catch (error) {
            console.warn('Failed to display notification', error);
        }
    }

    async function fetchWithAbort(url, options = {}) {
        const controller = new AbortController();
        state.currentAbortController = controller;
        const fetchOptions = { ...options, signal: controller.signal };
        try {
            return await fetch(url, fetchOptions);
        } finally {
            if (state.currentAbortController === controller) {
                state.currentAbortController = null;
            }
        }
    }

    function updateJobStatusMessage(statusPayload, fileName) {
        const parts = [];
        if (fileName) {
            parts.push(`ã€Œ${fileName}ã€`);
        }
        const stageLabel = translateStage(statusPayload?.stage);
        if (stageLabel) {
            parts.push(stageLabel);
        }
        if (statusPayload?.detail) {
            parts.push(statusPayload.detail);
        }
        const processed = Number(statusPayload?.processed_chunks || 0);
        const total = Number(statusPayload?.total_chunks || 0);
        if (total > 0) {
            parts.push(`(${processed}/${total} ãƒšãƒ¼ã‚¸)`);
        }
        const message = parts.filter(Boolean).join(' ');
        if (message) {
            setStatus(message, 'info');
        }
    }

    function translateStage(stage) {
        switch (stage) {
            case 'queued':
                return 'é †ç•ªå¾…ã¡';
            case 'analyzing':
                return 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè§£æä¸­â€¦';
            case 'exporting':
                return 'CSV æ•´å½¢ä¸­â€¦';
            case 'completed':
                return 'å®Œäº†';
            default:
                return '';
        }
    }

    function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }

    function setStatus(message, type) {
        statusBox.textContent = message;
        statusBox.className = type ? `status ${type}` : 'status';
        if (message) {
            statusBox.style.display = 'block';
            statusBox.classList.remove('visible');
            requestAnimationFrame(() => statusBox.classList.add('visible'));
        } else {
            statusBox.classList.remove('visible');
            setTimeout(() => {
                statusBox.style.display = 'none';
            }, 200);
        }
    }

    function describeDocType(value) {
        if (!value) return DOC_TYPE_LABELS[''];
        return DOC_TYPE_LABELS[value] || value;
    }

    function buildDropMessage(labelText) {
        const limitMb = state.limits?.gemini?.document_max_mb;
        if (limitMb) {
            return `${labelText}ã®æ›¸é¡ã‚’èª­ã¿å–ã‚Šã¾ã™ï¼ˆPDFã®ã¿ï¼1ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§ ${limitMb}MBï¼‰`;
        }
        return `${labelText}ã®æ›¸é¡ã‚’èª­ã¿å–ã‚Šã¾ã™ï¼ˆPDFã®ã¿å¯¾å¿œï¼‰`;
    }

    function describeDateFormat(value) {
        const normalized = normalizeDateFormat(value);
        return DATE_FORMAT_LABELS[normalized] || normalized || DATE_FORMAT_LABELS.auto;
    }

    function normalizeDateFormat(value) {
        const normalized = (value || '').toString().toLowerCase();
        if (normalized === 'western' || normalized === 'wareki') {
            return normalized;
        }
        return 'auto';
    }

    function getProcessingModeConfig() {
        const mode = state.analysisMode === 'gemini_flash' ? 'gemini-2.5-flash' : 'gemini-2.5-pro';
        return { processing_mode: 'gemini', gemini_model: mode };
    }

    function normalizedApiBase() {
        const raw = (state.apiBase || DEFAULT_API).trim();
        if (!raw) return DEFAULT_API;
        const base = raw.endsWith('/api') ? raw : `${raw.replace(/\/$/, '')}/api`;
        return base.replace(/\/$/, '');
    }

    function formatNumber(value) {
        if (value === null || value === undefined || value === '') return '';
        const num = Number(value);
        if (Number.isNaN(num)) return '';
        return num.toLocaleString('ja-JP');
    }

    function escapeHtml(value) {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function createDocId() {
        if (window.crypto?.randomUUID) {
            return window.crypto.randomUUID();
        }
        return `doc-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    }

    // ========================================
    // JON API Integration
    // ========================================
    const jonState = {
        properties: [],
        hotInstance: null,
        batchId: null,
        batchItems: [], // Store batch request items to track requested acquisitions
        batchResults: [],
        isProcessing: false,
    };

    const JON_ACQUISITION_OPTIONS = [
        { key: 'google_map', label: 'Googleãƒãƒƒãƒ—', forLand: true, forBuilding: true },
        { key: 'rosenka', label: 'è·¯ç·šä¾¡å›³', forLand: true, forBuilding: false },
        { key: 'touki', label: 'ç™»è¨˜ç°¿', forLand: true, forBuilding: true },
        { key: 'kozu', label: 'å…¬å›³', forLand: true, forBuilding: false },
        { key: 'chiseki', label: 'åœ°ç©æ¸¬é‡å›³', forLand: true, forBuilding: false },
        { key: 'tatemono', label: 'å»ºç‰©å›³é¢', forLand: false, forBuilding: true },
    ];

    // éƒ½é“åºœçœŒã‹ã‚‰å›½ç¨åºè·¯ç·šä¾¡ã‚µã‚¤ãƒˆã®URLã‚³ãƒ¼ãƒ‰ã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const PREF_TO_ROSENKA_CODE = {
        'åŒ—æµ·é“': 'hokkaido', 'é’æ£®': 'aomori', 'å²©æ‰‹': 'iwate', 'å®®åŸ': 'miyagi',
        'ç§‹ç”°': 'akita', 'å±±å½¢': 'yamagata', 'ç¦å³¶': 'fukushima', 'èŒ¨åŸ': 'ibaraki',
        'æ ƒæœ¨': 'tochigi', 'ç¾¤é¦¬': 'gunma', 'åŸ¼ç‰': 'saitama', 'åƒè‘‰': 'chiba',
        'æ±äº¬': 'tokyo', 'ç¥å¥ˆå·': 'kanagawa', 'æ–°æ½Ÿ': 'niigata', 'å¯Œå±±': 'toyama',
        'çŸ³å·': 'ishikawa', 'ç¦äº•': 'fukui', 'å±±æ¢¨': 'yamanashi', 'é•·é‡': 'nagano',
        'å²é˜œ': 'gifu', 'é™å²¡': 'shizuoka', 'æ„›çŸ¥': 'aichi', 'ä¸‰é‡': 'mie',
        'æ»‹è³€': 'shiga', 'äº¬éƒ½': 'kyoto', 'å¤§é˜ª': 'osaka', 'å…µåº«': 'hyogo',
        'å¥ˆè‰¯': 'nara', 'å’Œæ­Œå±±': 'wakayama', 'é³¥å–': 'tottori', 'å³¶æ ¹': 'shimane',
        'å²¡å±±': 'okayama', 'åºƒå³¶': 'hiroshima', 'å±±å£': 'yamaguchi', 'å¾³å³¶': 'tokushima',
        'é¦™å·': 'kagawa', 'æ„›åª›': 'ehime', 'é«˜çŸ¥': 'kochi', 'ç¦å²¡': 'fukuoka',
        'ä½è³€': 'saga', 'é•·å´': 'nagasaki', 'ç†Šæœ¬': 'kumamoto', 'å¤§åˆ†': 'oita',
        'å®®å´': 'miyazaki', 'é¹¿å…å³¶': 'kagoshima', 'æ²–ç¸„': 'okinawa',
    };

    // å¸‚åŒºç”ºæ‘åã‹ã‚‰éƒ½é“åºœçœŒã‚’æ¨æ¸¬
    function inferPrefectureFromMunicipality(municipality) {
        if (!municipality) return null;
        // æ”¿ä»¤æŒ‡å®šéƒ½å¸‚ãªã©ã‹ã‚‰éƒ½é“åºœçœŒã‚’æ¨æ¸¬
        const cityToPref = {
            'æœ­å¹Œå¸‚': 'åŒ—æµ·é“', 'ä»™å°å¸‚': 'å®®åŸ', 'ã•ã„ãŸã¾å¸‚': 'åŸ¼ç‰', 'åƒè‘‰å¸‚': 'åƒè‘‰',
            'æ¨ªæµœå¸‚': 'ç¥å¥ˆå·', 'å·å´å¸‚': 'ç¥å¥ˆå·', 'ç›¸æ¨¡åŸå¸‚': 'ç¥å¥ˆå·', 'æ–°æ½Ÿå¸‚': 'æ–°æ½Ÿ',
            'é™å²¡å¸‚': 'é™å²¡', 'æµœæ¾å¸‚': 'é™å²¡', 'åå¤å±‹å¸‚': 'æ„›çŸ¥', 'äº¬éƒ½å¸‚': 'äº¬éƒ½',
            'å¤§é˜ªå¸‚': 'å¤§é˜ª', 'å ºå¸‚': 'å¤§é˜ª', 'ç¥æˆ¸å¸‚': 'å…µåº«', 'å²¡å±±å¸‚': 'å²¡å±±',
            'åºƒå³¶å¸‚': 'åºƒå³¶', 'åŒ—ä¹å·å¸‚': 'ç¦å²¡', 'ç¦å²¡å¸‚': 'ç¦å²¡', 'ç†Šæœ¬å¸‚': 'ç†Šæœ¬',
        };
        for (const [city, pref] of Object.entries(cityToPref)) {
            if (municipality.startsWith(city)) return pref;
        }
        // çœŒåãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
        for (const pref of Object.keys(PREF_TO_ROSENKA_CODE)) {
            if (municipality.includes(pref)) return pref;
        }
        return null;
    }

    // éƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ«ã®è·¯ç·šä¾¡ãƒ»å€ç‡è¡¨URLã‚’ç”Ÿæˆ
    function getRosenkaUrl(prefecture) {
        const code = PREF_TO_ROSENKA_CODE[prefecture];
        if (code) {
            // ä»¤å’Œ7å¹´åˆ†ï¼ˆæœ€æ–°å¹´åº¦ï¼‰ã®è·¯ç·šä¾¡ãƒšãƒ¼ã‚¸
            return `https://www.rosenka.nta.go.jp/main_r07/${code}/`;
        }
        return 'https://www.rosenka.nta.go.jp/';
    }

    async function checkJonApiStatus() {
        try {
            const res = await fetch(`${normalizedApiBase()}/jon/status`);
            if (!res.ok) return { configured: false, has_touki_credentials: false };
            return await res.json();
        } catch (error) {
            console.warn('JON API status check failed:', error);
            return { configured: false, has_touki_credentials: false };
        }
    }

    function renderJonApiPanel(container, properties, isConfigured = false, hasToukiCredentials = false) {
        // Store properties with full address for later use (éƒ½é“åºœçœŒãŒã‚ã‚Œã°å«ã‚ã‚‹)
        jonState.properties = properties.map(p => ({
            ...p,
            fullAddress: `${p.location_prefecture || ''}${p.city}${p.address}`.trim()
        }));

        const jonContainer = document.createElement('div');
        jonContainer.className = 'jon-container';
        jonContainer.id = 'jonApiContainer';

        const title = document.createElement('h4');
        title.textContent = 'ç™»è¨˜ãƒ»åœ°å›³æƒ…å ±ã‚’å–å¾—';
        jonContainer.appendChild(title);

        // Show configuration status
        if (!isConfigured) {
            const notice = document.createElement('p');
            notice.style.margin = '0 0 1rem';
            notice.style.padding = '0.6rem';
            notice.style.background = '#fef3c7';
            notice.style.borderRadius = '6px';
            notice.style.color = '#92400e';
            notice.style.fontSize = '0.85rem';
            notice.textContent = 'JON APIãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ã®ç’°å¢ƒå¤‰æ•°ã«JON_CLIENT_IDã¨JON_CLIENT_SECRETã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
            jonContainer.appendChild(notice);
        } else if (!hasToukiCredentials) {
            const notice = document.createElement('p');
            notice.style.margin = '0 0 1rem';
            notice.style.padding = '0.6rem';
            notice.style.background = '#dbeafe';
            notice.style.borderRadius = '6px';
            notice.style.color = '#1e40af';
            notice.style.fontSize = '0.85rem';
            notice.textContent = 'ç™»è¨˜æƒ…å ±æä¾›ã‚µãƒ¼ãƒ“ã‚¹ã®èªè¨¼æƒ…å ±ãŒæœªè¨­å®šã§ã™ã€‚ç™»è¨˜ç°¿å–å¾—ã«ã¯TOUKI_LOGIN_IDã¨TOUKI_PASSWORDã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚';
            jonContainer.appendChild(notice);
        }

        // Per-property acquisition table
        const tableContainer = document.createElement('div');
        tableContainer.className = 'jon-property-table';
        tableContainer.id = 'jonPropertyTable';

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.fontSize = '0.9rem';

        // Header
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                <th style="padding:0.6rem;text-align:left;width:50px;white-space:nowrap;">ç¨®åˆ¥</th>
                <th style="padding:0.6rem;text-align:left;">æ‰€åœ¨åœ°</th>
                <th style="padding:0.6rem;text-align:center;width:70px;white-space:nowrap;"><input type="checkbox" id="bulk-gmap" title="å…¨ã¦é¸æŠ/è§£é™¤" checked><br><span style="font-size:0.7rem;">Gãƒãƒƒãƒ—</span></th>
                <th style="padding:0.6rem;text-align:center;width:55px;white-space:nowrap;"><input type="checkbox" id="bulk-touki" title="å…¨ã¦é¸æŠ/è§£é™¤" ${hasToukiCredentials ? '' : 'disabled'}><br><span style="font-size:0.7rem;">ç™»è¨˜ç°¿</span></th>
                <th style="padding:0.6rem;text-align:center;width:45px;white-space:nowrap;"><input type="checkbox" id="bulk-kozu" title="å…¨ã¦é¸æŠ/è§£é™¤" ${hasToukiCredentials ? '' : 'disabled'}><br><span style="font-size:0.7rem;">å…¬å›³</span></th>
                <th style="padding:0.6rem;text-align:center;width:55px;white-space:nowrap;"><input type="checkbox" id="bulk-rosenka" title="å…¨ã¦é¸æŠ/è§£é™¤" checked><br><span style="font-size:0.7rem;">è·¯ç·šä¾¡</span></th>
                <th style="padding:0.6rem;text-align:center;width:70px;white-space:nowrap;"><input type="checkbox" id="bulk-drawing" title="å…¨ã¦é¸æŠ/è§£é™¤" ${hasToukiCredentials ? '' : 'disabled'}><br><span style="font-size:0.7rem;">å›³é¢</span></th>
            </tr>
        `;
        table.appendChild(thead);

        // Body
        const tbody = document.createElement('tbody');
        jonState.properties.forEach((prop, idx) => {
            // Read current values from Handsontable if available
            const hotData = jonState.hotInstance ? jonState.hotInstance.getSourceData() : null;
            const hotRow = hotData ? hotData[idx] : null;
            const isLand = hotRow ? hotRow.category !== 'å®¶å±‹' : prop.category === 'land';
            const displayAddress = hotRow ? `${hotRow.municipality || ''}${hotRow.location || ''}`.trim() : (prop.fullAddress || prop.id);

            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #e2e8f0';
            tr.dataset.propIdx = idx;

            // ç¨®åˆ¥
            const typeTd = document.createElement('td');
            typeTd.style.padding = '0.5rem 0.6rem';
            typeTd.innerHTML = `<span class="property-type-badge ${isLand ? 'land' : 'building'}">${isLand ? 'åœŸåœ°' : 'å®¶å±‹'}</span>`;
            tr.appendChild(typeTd);

            // æ‰€åœ¨åœ°
            const addressTd = document.createElement('td');
            addressTd.style.padding = '0.5rem 0.6rem';
            addressTd.textContent = displayAddress;
            tr.appendChild(addressTd);

            // Googleãƒãƒƒãƒ— checkbox
            const gmapTd = document.createElement('td');
            gmapTd.style.padding = '0.5rem 0.6rem';
            gmapTd.style.textAlign = 'center';
            gmapTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="google_map" checked>`;
            tr.appendChild(gmapTd);

            // ç™»è¨˜ç°¿ checkbox
            const toukiTd = document.createElement('td');
            toukiTd.style.padding = '0.5rem 0.6rem';
            toukiTd.style.textAlign = 'center';
            const toukiDisabled = !hasToukiCredentials ? 'disabled' : '';
            toukiTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="touki" ${toukiDisabled}>`;
            tr.appendChild(toukiTd);

            // å…¬å›³ checkbox (åœŸåœ°ã®ã¿)
            const kozuTd = document.createElement('td');
            kozuTd.style.padding = '0.5rem 0.6rem';
            kozuTd.style.textAlign = 'center';
            if (isLand) {
                const kozuDisabled = !hasToukiCredentials ? 'disabled' : '';
                kozuTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="kozu" ${kozuDisabled}>`;
            } else {
                kozuTd.innerHTML = `<span style="color:#94a3b8;">â€•</span>`;
            }
            tr.appendChild(kozuTd);

            // è·¯ç·šä¾¡ checkbox (åœŸåœ°ã®ã¿)
            const rosenkaTd = document.createElement('td');
            rosenkaTd.style.padding = '0.5rem 0.6rem';
            rosenkaTd.style.textAlign = 'center';
            if (isLand) {
                rosenkaTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="rosenka" checked>`;
            } else {
                rosenkaTd.innerHTML = `<span style="color:#94a3b8;">â€•</span>`;
            }
            tr.appendChild(rosenkaTd);

            // åœ°ç©æ¸¬é‡å›³ / å»ºç‰©å›³é¢ checkbox
            const drawingTd = document.createElement('td');
            drawingTd.style.padding = '0.5rem 0.6rem';
            drawingTd.style.textAlign = 'center';
            if (isLand) {
                const chisekiDisabled = !hasToukiCredentials ? 'disabled' : '';
                drawingTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="chiseki" ${chisekiDisabled}>`;
            } else {
                const tatemonoDisabled = !hasToukiCredentials ? 'disabled' : '';
                drawingTd.innerHTML = `<input type="checkbox" data-prop="${idx}" data-acq="tatemono" ${tatemonoDisabled}>`;
            }
            tr.appendChild(drawingTd);

            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableContainer.appendChild(table);
        jonContainer.appendChild(tableContainer);

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®é€£å‹•: ç™»è¨˜ç°¿ãƒ»è·¯ç·šä¾¡ãƒ»å›³é¢ã«ãƒã‚§ãƒƒã‚¯ â†’ åœ°å›³ã‚‚è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        tableContainer.addEventListener('change', (e) => {
            const checkbox = e.target;
            if (checkbox.type !== 'checkbox') return;

            const propIdx = checkbox.dataset.prop;
            const acqType = checkbox.dataset.acq;
            const row = tableContainer.querySelector(`tr[data-prop-idx="${propIdx}"]`);
            if (!row) return;

            const gmapCheckbox = row.querySelector('input[data-acq="google_map"]');
            const dependentCheckboxes = row.querySelectorAll('input[data-acq="touki"], input[data-acq="kozu"], input[data-acq="rosenka"], input[data-acq="chiseki"], input[data-acq="tatemono"]');

            if (acqType === 'google_map') {
                // åœ°å›³ã‚’ã‚ªãƒ•ã«ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã€ä»–ã«ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚Œã°è­¦å‘Š
                if (!checkbox.checked) {
                    const hasOtherChecked = Array.from(dependentCheckboxes).some(cb => cb.checked && !cb.disabled);
                    if (hasOtherChecked) {
                        checkbox.checked = true; // æˆ»ã™
                        alert('ç™»è¨˜ç°¿ãƒ»è·¯ç·šä¾¡ãƒ»å›³é¢ã‚’å–å¾—ã™ã‚‹ã«ã¯ä½ç½®ç‰¹å®šï¼ˆåœ°å›³ï¼‰ãŒå¿…è¦ã§ã™ã€‚å…ˆã«ä»–ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„ã€‚');
                    }
                }
            } else {
                // ç™»è¨˜ç°¿ãƒ»è·¯ç·šä¾¡ãƒ»å›³é¢ã‚’ã‚ªãƒ³ã«ã—ãŸå ´åˆã€åœ°å›³ã‚‚è‡ªå‹•ã§ã‚ªãƒ³
                if (checkbox.checked && gmapCheckbox && !gmapCheckbox.checked) {
                    gmapCheckbox.checked = true;
                }
            }
        });

        // ä¸€æ‹¬é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆtableContainerã‚’ä½¿ç”¨ï¼‰
        const bulkCheckboxConfig = [
            { bulkId: 'bulk-gmap', acq: 'google_map' },
            { bulkId: 'bulk-touki', acq: 'touki' },
            { bulkId: 'bulk-kozu', acq: 'kozu' },
            { bulkId: 'bulk-rosenka', acq: 'rosenka' },
            { bulkId: 'bulk-drawing', acq: ['chiseki', 'tatemono'] },  // å›³é¢ã¯2ç¨®é¡
        ];

        bulkCheckboxConfig.forEach(({ bulkId, acq }) => {
            // tableContainerå†…ã§æ¤œç´¢ï¼ˆDOMã«è¿½åŠ å‰ã§ã‚‚å‹•ä½œï¼‰
            const bulkCb = tableContainer.querySelector(`#${bulkId}`);
            if (!bulkCb) return;

            bulkCb.addEventListener('change', () => {
                const acqTypes = Array.isArray(acq) ? acq : [acq];
                const checked = bulkCb.checked;

                acqTypes.forEach(acqType => {
                    const targetCheckboxes = tableContainer.querySelectorAll(`input[data-acq="${acqType}"]:not(:disabled)`);
                    targetCheckboxes.forEach(cb => {
                        cb.checked = checked;
                    });
                });

                // åœ°å›³ä»¥å¤–ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸå ´åˆã€åœ°å›³ã‚‚è‡ªå‹•ãƒã‚§ãƒƒã‚¯
                if (checked && bulkId !== 'bulk-gmap') {
                    const gmapBulk = tableContainer.querySelector('#bulk-gmap');
                    if (gmapBulk && !gmapBulk.checked) {
                        gmapBulk.checked = true;
                        const gmapCheckboxes = tableContainer.querySelectorAll('input[data-acq="google_map"]:not(:disabled)');
                        gmapCheckboxes.forEach(cb => cb.checked = true);
                    }
                }
            });
        });

        // Actions
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'jon-actions';
        actionsDiv.style.display = 'flex';
        actionsDiv.style.alignItems = 'center';
        actionsDiv.style.gap = '1rem';
        actionsDiv.style.flexWrap = 'wrap';

        const executeBtn = document.createElement('button');
        executeBtn.type = 'button';
        executeBtn.className = 'primary';
        executeBtn.id = 'executeJonBtn';
        executeBtn.textContent = 'æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ';
        executeBtn.disabled = !isConfigured;
        executeBtn.addEventListener('click', () => executeJonBatchFromProperties(properties));
        actionsDiv.appendChild(executeBtn);

        // å€ç‡åœ°åŸŸã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const bairitsuLabel = document.createElement('label');
        bairitsuLabel.style.display = 'flex';
        bairitsuLabel.style.alignItems = 'center';
        bairitsuLabel.style.gap = '0.3rem';
        bairitsuLabel.style.fontSize = '0.85rem';
        bairitsuLabel.style.color = '#475569';
        const bairitsuCheckbox = document.createElement('input');
        bairitsuCheckbox.type = 'checkbox';
        bairitsuCheckbox.id = 'skipKozuForBairitsu';
        bairitsuCheckbox.checked = true;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ªãƒ³
        bairitsuLabel.appendChild(bairitsuCheckbox);
        bairitsuLabel.appendChild(document.createTextNode('å€ç‡åœ°åŸŸã¯å…¬å›³ã‚’ã‚¹ã‚­ãƒƒãƒ—'));
        actionsDiv.appendChild(bairitsuLabel);

        jonContainer.appendChild(actionsDiv);

        // Progress area
        const progressDiv = document.createElement('div');
        progressDiv.className = 'jon-progress';
        progressDiv.id = 'jonProgress';
        progressDiv.style.display = 'none';
        jonContainer.appendChild(progressDiv);

        // Results area
        const resultsDiv = document.createElement('div');
        resultsDiv.className = 'jon-results';
        resultsDiv.id = 'jonResults';
        resultsDiv.style.display = 'none';
        jonContainer.appendChild(resultsDiv);

        container.appendChild(jonContainer);
    }

    async function executeJonBatchFromProperties(properties) {
        // Read per-property checkboxes from the table
        const tableContainer = document.getElementById('jonPropertyTable');
        if (!tableContainer) {
            alert('ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        // Read current values from Handsontable (user may have edited)
        const hotData = jonState.hotInstance ? jonState.hotInstance.getSourceData() : null;

        // Build items with per-property acquisitions
        const items = [];
        jonState.properties.forEach((prop, idx) => {
            const checkboxes = tableContainer.querySelectorAll(`input[type="checkbox"][data-prop="${idx}"]:checked:not(:disabled)`);
            const acquisitions = Array.from(checkboxes).map(cb => cb.dataset.acq);

            if (acquisitions.length > 0) {
                // Use Handsontable's current data if available (reflects user edits)
                let address = prop.fullAddress || `${prop.city}${prop.address}`;
                let propertyType = prop.category === 'building' ? 'building' : 'land';
                if (hotData && hotData[idx]) {
                    const row = hotData[idx];
                    address = `${row.municipality || ''}${row.location || ''}`.trim() || address;
                    propertyType = row.category === 'å®¶å±‹' ? 'building' : 'land';
                }

                items.push({
                    id: prop.id,
                    address: address,
                    property_type: propertyType,
                    acquisitions: acquisitions,
                });
            }
        });

        if (!items.length) {
            alert('å–å¾—é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // Store batch items to track requested acquisitions for result display
        jonState.batchItems = items;

        const executeBtn = document.getElementById('executeJonBtn');
        const progressDiv = document.getElementById('jonProgress');
        const resultsDiv = document.getElementById('jonResults');

        if (executeBtn) executeBtn.disabled = true;
        if (progressDiv) {
            progressDiv.style.display = 'block';
            progressDiv.textContent = 'ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
        }
        if (resultsDiv) resultsDiv.style.display = 'none';

        jonState.isProcessing = true;

        try {
            // å€ç‡åœ°åŸŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
            const skipKozuCheckbox = document.getElementById('skipKozuForBairitsu');
            const skipKozuForBairitsu = skipKozuCheckbox ? skipKozuCheckbox.checked : false;

            const res = await fetch(`${normalizedApiBase()}/jon/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    properties: items,
                    skip_kozu_for_bairitsu: skipKozuForBairitsu,
                }),
            });

            if (!res.ok) {
                throw new Error(`ãƒãƒƒãƒå‡¦ç†ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ${res.status})`);
            }

            const batchResponse = await res.json();
            jonState.batchId = batchResponse.batch_id;

            await pollJonBatchStatus(batchResponse.batch_id);

        } catch (error) {
            console.error('JON batch error:', error);
            if (progressDiv) {
                progressDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
            }
        } finally {
            jonState.isProcessing = false;
            if (executeBtn) executeBtn.disabled = false;
        }
    }

    async function pollJonBatchStatus(batchId) {
        const progressDiv = document.getElementById('jonProgress');
        const resultsDiv = document.getElementById('jonResults');

        while (true) {
            try {
                const res = await fetch(`${normalizedApiBase()}/jon/batch/${batchId}`);
                if (!res.ok) throw new Error('ãƒãƒƒãƒçŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

                const status = await res.json();

                if (progressDiv) {
                    progressDiv.textContent = `å‡¦ç†ä¸­... ${status.completed}/${status.total} ä»¶å®Œäº†`;
                }

                if (status.status === 'completed' || status.status === 'failed') {
                    jonState.batchResults = status.results;
                    renderJonResults(status.results);
                    if (progressDiv) {
                        progressDiv.textContent = status.status === 'completed'
                            ? `å®Œäº†: ${status.completed}/${status.total} ä»¶`
                            : 'ãƒãƒƒãƒå‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ';
                    }
                    break;
                }

                await sleep(2000);
            } catch (error) {
                console.error('Polling error:', error);
                if (progressDiv) {
                    progressDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
                break;
            }
        }
    }

    function renderJonResults(results) {
        const resultsDiv = document.getElementById('jonResults');
        if (!resultsDiv) return;

        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'block';

        const title = document.createElement('h4');
        title.textContent = 'å–å¾—çµæœ';
        resultsDiv.appendChild(title);

        // å¤–éƒ¨ã‚µã‚¤ãƒˆãƒªãƒ³ã‚¯ãƒãƒ¼
        const extLinksBar = document.createElement('div');
        extLinksBar.style.cssText = 'display:flex;gap:16px;align-items:center;margin-bottom:12px;padding:10px 14px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;';
        const extLabel = document.createElement('span');
        extLabel.style.cssText = 'font-size:0.85rem;color:#475569;white-space:nowrap;font-weight:500;';
        extLabel.textContent = 'å¤–éƒ¨ã‚µã‚¤ãƒˆ:';
        extLinksBar.appendChild(extLabel);

        [{url:'https://app.zip-site.com/txac/app/index.htm', icon:'image/zenrin_logo.svg', alt:'ZENRIN GIS package'},
         {url:'https://map.maff.go.jp/FarmInformation/Index?dlgName=notes', icon:'image/emaff_logo.svg', alt:'eMAFFè¾²åœ°ãƒŠãƒ“'}
        ].forEach(site => {
            const a = document.createElement('a');
            a.href = site.url;
            a.target = '_blank';
            a.rel = 'noopener';
            a.title = site.alt;
            a.style.cssText = 'display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:#fff;border:1px solid #cbd5e1;border-radius:6px;text-decoration:none;cursor:pointer;transition:all 0.2s ease;box-shadow:0 1px 2px rgba(0,0,0,0.05);';
            a.onmouseenter = () => { a.style.borderColor = '#3b82f6'; a.style.boxShadow = '0 2px 6px rgba(59,130,246,0.2)'; a.style.transform = 'translateY(-1px)'; };
            a.onmouseleave = () => { a.style.borderColor = '#cbd5e1'; a.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)'; a.style.transform = 'translateY(0)'; };
            const img = document.createElement('img');
            img.src = site.icon;
            img.alt = site.alt;
            img.style.cssText = 'height:32px;width:auto;';
            a.appendChild(img);
            const arrow = document.createElement('span');
            arrow.textContent = '\u2197';
            arrow.style.cssText = 'font-size:1rem;color:#94a3b8;transition:color 0.2s;';
            a.appendChild(arrow);
            a.addEventListener('mouseenter', () => arrow.style.color = '#3b82f6');
            a.addEventListener('mouseleave', () => arrow.style.color = '#94a3b8');
            extLinksBar.appendChild(a);
        });
        resultsDiv.appendChild(extLinksBar);

        // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        const table = document.createElement('table');
        table.className = 'jon-result-table';

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th class="col-status">çŠ¶æ…‹</th>
                <th class="col-type">ç¨®åˆ¥</th>
                <th class="col-address">æ‰€åœ¨åœ°</th>
                <th class="col-accuracy">ç²¾åº¦</th>
                <th class="col-link">Gãƒãƒƒãƒ—</th>
                <th class="col-link">åœ°ä¾¡ãƒãƒƒãƒ—</th>
                <th class="col-link">ç™»è¨˜ç°¿</th>
                <th class="col-link">å…¬å›³</th>
                <th class="col-link">è·¯ç·šä¾¡</th>
                <th class="col-link">å›³é¢</th>
            </tr>
        `;
        table.appendChild(thead);

        // ãƒœãƒ‡ã‚£
        const tbody = document.createElement('tbody');

        results.forEach(result => {
            const originalProp = jonState.properties.find(p => p.id === result.id);
            const fullAddress = originalProp?.fullAddress || result.id;
            const isLand = originalProp?.category === 'land';

            const tr = document.createElement('tr');

            // çŠ¶æ…‹
            const tdStatus = document.createElement('td');
            tdStatus.className = 'col-status';
            const statusBadge = document.createElement('span');
            statusBadge.className = `jon-status-badge ${result.status}`;
            statusBadge.textContent = result.status === 'completed' ? 'å®Œäº†'
                : result.status === 'failed' ? 'å¤±æ•—'
                : result.status === 'processing' ? 'å‡¦ç†ä¸­' : 'å¾…æ©Ÿä¸­';
            tdStatus.appendChild(statusBadge);
            tr.appendChild(tdStatus);

            // ç¨®åˆ¥
            const tdType = document.createElement('td');
            tdType.className = 'col-type';
            const typeBadge = document.createElement('span');
            typeBadge.className = `property-type-badge ${isLand ? 'land' : 'building'}`;
            typeBadge.textContent = isLand ? 'åœŸåœ°' : 'å®¶å±‹';
            tdType.appendChild(typeBadge);
            tr.appendChild(tdType);

            // æ‰€åœ¨åœ°
            const tdAddress = document.createElement('td');
            tdAddress.className = 'col-address';
            tdAddress.textContent = fullAddress;
            if (result.error) {
                const errorSpan = document.createElement('div');
                errorSpan.style.color = '#991b1b';
                errorSpan.style.fontSize = '0.8rem';
                errorSpan.textContent = `ã‚¨ãƒ©ãƒ¼: ${result.error}`;
                tdAddress.appendChild(errorSpan);
            }
            // ç²¾åº¦è­¦å‘Šã‚’è¡¨ç¤ºï¼ˆå¼·åˆ¶å–å¾—ãƒœã‚¿ãƒ³ä»˜ãï¼‰
            if (result.accuracy_warning) {
                const warningContainer = document.createElement('div');
                warningContainer.className = 'accuracy-warning-container';
                warningContainer.id = `warning-${result.id}`;

                const warningSpan = document.createElement('div');
                warningSpan.className = 'accuracy-warning';
                warningSpan.textContent = result.accuracy_warning;
                warningContainer.appendChild(warningSpan);

                // å¼·åˆ¶å–å¾—ãƒœã‚¿ãƒ³
                const forceBtn = document.createElement('button');
                forceBtn.type = 'button';
                forceBtn.className = 'force-fetch-btn';
                forceBtn.textContent = 'ç™»è¨˜æƒ…å ±ã‚’å–å¾—ï¼ˆç²¾åº¦ä½ï¼‰';
                forceBtn.title = 'ä½ç½®ç²¾åº¦ãŒä½ã„ã§ã™ãŒã€ç™»è¨˜æƒ…å ±ã®å–å¾—ã‚’è©¦ã¿ã¾ã™';
                forceBtn.addEventListener('click', async () => {
                    await forceRegistrationFetch(result.id, forceBtn, warningContainer);
                });
                warningContainer.appendChild(forceBtn);

                tdAddress.appendChild(warningContainer);
            }
            tr.appendChild(tdAddress);

            // ç²¾åº¦
            const tdAccuracy = document.createElement('td');
            tdAccuracy.className = 'col-accuracy';
            const locatingLevel = result.locating_level || 0;
            const accuracyLabel = result.accuracy_label || 'ä¸æ˜';
            const accuracyBadge = document.createElement('span');
            if (locatingLevel >= 7) {
                accuracyBadge.className = 'accuracy-badge high';
            } else if (locatingLevel >= 5) {
                accuracyBadge.className = 'accuracy-badge medium';
            } else {
                accuracyBadge.className = 'accuracy-badge low';
            }
            accuracyBadge.textContent = accuracyLabel;
            accuracyBadge.title = `ä½ç½®ç‰¹å®šãƒ¬ãƒ™ãƒ«: ${locatingLevel}`;
            tdAccuracy.appendChild(accuracyBadge);
            tr.appendChild(tdAccuracy);

            // åœ°å›³
            const tdMap = document.createElement('td');
            tdMap.className = 'col-link';
            if (result.google_map_url) {
                const mapLink = document.createElement('a');
                mapLink.href = result.google_map_url;
                mapLink.target = '_blank';
                mapLink.rel = 'noopener';
                mapLink.className = 'jon-result-link';
                mapLink.textContent = 'é–‹ã';
                tdMap.appendChild(mapLink);
            } else {
                tdMap.textContent = '-';
                tdMap.style.color = '#94a3b8';
            }
            tr.appendChild(tdMap);

            // åœ°ä¾¡ãƒãƒƒãƒ—
            const tdChika = document.createElement('td');
            tdChika.className = 'col-link';
            if (result.chikamap_url) {
                const chikaLink = document.createElement('a');
                chikaLink.href = result.chikamap_url;
                chikaLink.target = '_blank';
                chikaLink.rel = 'noopener';
                chikaLink.className = 'jon-result-link';
                chikaLink.textContent = 'é–‹ã';
                tdChika.appendChild(chikaLink);
            } else {
                tdChika.textContent = '-';
                tdChika.style.color = '#94a3b8';
            }
            tr.appendChild(tdChika);

            // ç™»è¨˜
            const tdTouki = document.createElement('td');
            tdTouki.className = 'col-link';
            if (result.registration?.pdf_url) {
                const pdfLink = document.createElement('a');
                pdfLink.href = result.registration.pdf_url;
                pdfLink.target = '_blank';
                pdfLink.rel = 'noopener';
                pdfLink.className = 'jon-result-link';
                pdfLink.textContent = 'PDF';
                tdTouki.appendChild(pdfLink);
            } else {
                tdTouki.textContent = '-';
                tdTouki.style.color = '#94a3b8';
            }
            tr.appendChild(tdTouki);

            // å…¬å›³
            const tdKozu = document.createElement('td');
            tdKozu.className = 'col-link';
            if (result.kozu_pdf_url) {
                const kozuLink = document.createElement('a');
                kozuLink.href = result.kozu_pdf_url;
                kozuLink.target = '_blank';
                kozuLink.rel = 'noopener';
                kozuLink.className = 'jon-result-link';
                kozuLink.textContent = 'PDF';
                tdKozu.appendChild(kozuLink);
            } else {
                // å€ç‡åœ°åŸŸã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆ
                const batchItem = jonState.batchItems.find(item => item.id === result.id);
                const requestedKozu = batchItem?.acquisitions?.includes('kozu');
                if (result.is_bairitsu && requestedKozu) {
                    tdKozu.textContent = 'ã‚¹ã‚­ãƒƒãƒ—';
                    tdKozu.style.color = '#92400e';
                    tdKozu.style.fontSize = '0.8rem';
                    tdKozu.title = 'å€ç‡åœ°åŸŸã®ãŸã‚å…¬å›³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ';
                } else {
                    tdKozu.textContent = '-';
                    tdKozu.style.color = '#94a3b8';
                }
            }
            tr.appendChild(tdKozu);

            // è·¯ç·šä¾¡
            const tdRosenka = document.createElement('td');
            tdRosenka.className = 'col-link';
            const rosenkaGroup = document.createElement('div');
            rosenkaGroup.className = 'jon-link-group';

            // ãƒ‡ãƒãƒƒã‚°: rosenka_urls ã®ç¢ºèª
            console.log(`[${result.id}] rosenka_urls:`, result.rosenka_urls, 'rosenka_image:', !!result.rosenka_image, 'is_bairitsu:', result.is_bairitsu);

            // å€ç‡åœ°åŸŸã®å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
            if (result.is_bairitsu) {
                const bairitsuBadge = document.createElement('span');
                bairitsuBadge.style.cssText = 'background:#fef3c7;color:#92400e;padding:0.1rem 0.3rem;border-radius:3px;font-size:0.7rem;margin-right:0.3rem;';
                bairitsuBadge.textContent = 'å€ç‡';
                bairitsuBadge.title = 'å€ç‡åœ°åŸŸã®ãŸã‚è·¯ç·šä¾¡å›³ã¯ã‚ã‚Šã¾ã›ã‚“';
                rosenkaGroup.appendChild(bairitsuBadge);
            }

            if (result.rosenka_image) {
                const imgBtn = document.createElement('button');
                imgBtn.type = 'button';
                imgBtn.className = 'secondary small';
                imgBtn.style.padding = '0.2rem 0.4rem';
                imgBtn.style.fontSize = '0.75rem';
                imgBtn.textContent = 'ç”»åƒ';
                imgBtn.addEventListener('click', () => showRosenkaImage(result.rosenka_image));
                rosenkaGroup.appendChild(imgBtn);

                if (result.rosenka_urls && result.rosenka_urls.length > 0) {
                    result.rosenka_urls.forEach((url, idx) => {
                        const ntaLink = document.createElement('a');
                        ntaLink.href = url;
                        ntaLink.target = '_blank';
                        ntaLink.rel = 'noopener';
                        ntaLink.className = 'jon-result-link';
                        ntaLink.textContent = result.rosenka_urls.length > 1 ? `è·¯ç·šä¾¡å›³${idx + 1}` : 'è·¯ç·šä¾¡å›³';
                        ntaLink.title = 'å›½ç¨åºã®è·¯ç·šä¾¡å›³ãƒšãƒ¼ã‚¸ã§ç¢ºèª';
                        rosenkaGroup.appendChild(ntaLink);
                    });
                }
                tdRosenka.appendChild(rosenkaGroup);
            } else if (isLand) {
                const batchItem = jonState.batchItems.find(item => item.id === result.id);
                if (batchItem?.acquisitions?.includes('rosenka')) {
                    if (result.rosenka_urls && result.rosenka_urls.length > 0) {
                        result.rosenka_urls.forEach((url, idx) => {
                            const bairitsuLink = document.createElement('a');
                            bairitsuLink.href = url;
                            bairitsuLink.target = '_blank';
                            bairitsuLink.rel = 'noopener';
                            bairitsuLink.className = 'jon-result-link';
                            bairitsuLink.textContent = result.rosenka_urls.length > 1 ? `å€ç‡è¡¨${idx + 1}` : 'å€ç‡è¡¨';
                            bairitsuLink.title = 'å€ç‡åœ°åŸŸã§ã™ã€‚å›½ç¨åºã®å€ç‡è¡¨ã§è©•ä¾¡é¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                            rosenkaGroup.appendChild(bairitsuLink);
                        });
                    } else {
                        const municipality = originalProp?.city || originalProp?.location_municipality || '';
                        const prefecture = originalProp?.location_prefecture || inferPrefectureFromMunicipality(municipality);
                        const rosenkaUrl = getRosenkaUrl(prefecture);

                        const bairitsuLink = document.createElement('a');
                        bairitsuLink.href = rosenkaUrl;
                        bairitsuLink.target = '_blank';
                        bairitsuLink.rel = 'noopener';
                        bairitsuLink.className = 'jon-result-link';
                        bairitsuLink.textContent = prefecture ? `${prefecture}ã®å€ç‡è¡¨` : 'å€ç‡è¡¨';
                        bairitsuLink.title = 'å€ç‡åœ°åŸŸã§ã™ã€‚å›½ç¨åºã®å€ç‡è¡¨ã§è©•ä¾¡é¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        rosenkaGroup.appendChild(bairitsuLink);
                    }
                    tdRosenka.appendChild(rosenkaGroup);
                } else {
                    tdRosenka.textContent = '-';
                    tdRosenka.style.color = '#94a3b8';
                }
            } else {
                tdRosenka.textContent = '-';
                tdRosenka.style.color = '#94a3b8';
            }
            tr.appendChild(tdRosenka);

            // å›³é¢ï¼ˆåœ°ç©æ¸¬é‡å›³ / å»ºç‰©å›³é¢ï¼‰
            const tdDrawing = document.createElement('td');
            tdDrawing.className = 'col-link';
            const drawingUrl = isLand ? result.chiseki_pdf_url : result.tatemono_pdf_url;
            if (drawingUrl) {
                const drawingLink = document.createElement('a');
                drawingLink.href = drawingUrl;
                drawingLink.target = '_blank';
                drawingLink.rel = 'noopener';
                drawingLink.className = 'jon-result-link';
                drawingLink.textContent = 'PDF';
                tdDrawing.appendChild(drawingLink);
            } else {
                tdDrawing.textContent = '-';
                tdDrawing.style.color = '#94a3b8';
            }
            tr.appendChild(tdDrawing);

            tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        resultsDiv.appendChild(table);

        // Export buttons
        const exportDiv = document.createElement('div');
        exportDiv.style.marginTop = '1rem';
        exportDiv.style.display = 'flex';
        exportDiv.style.gap = '0.6rem';

        const jsonBtn = document.createElement('button');
        jsonBtn.type = 'button';
        jsonBtn.className = 'secondary small';
        jsonBtn.textContent = 'JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
        jsonBtn.addEventListener('click', () => exportJonResults('json'));
        exportDiv.appendChild(jsonBtn);

        const csvBtn = document.createElement('button');
        csvBtn.type = 'button';
        csvBtn.className = 'secondary small';
        csvBtn.textContent = 'CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';
        csvBtn.addEventListener('click', () => exportJonResults('csv'));
        exportDiv.appendChild(csvBtn);

        resultsDiv.appendChild(exportDiv);
    }

    async function forceRegistrationFetch(itemId, button, warningContainer) {
        if (!jonState.batchId) {
            alert('ãƒãƒƒãƒIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        button.disabled = true;
        button.textContent = 'å–å¾—ä¸­...';

        try {
            const response = await fetch('/api/jon/force-registration', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    batch_id: jonState.batchId,
                    item_id: itemId,
                    pdf_types: [1, 3]  // ç™»è¨˜ç°¿ã¨å…¬å›³
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // æˆåŠŸæ™‚ï¼šè­¦å‘Šã‚’å‰Šé™¤ã—ã€çµæœã‚’æ›´æ–°
                warningContainer.innerHTML = '<div style="color:#059669;font-size:0.8rem;">ç™»è¨˜æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ</div>';

                // çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã®è©²å½“è¡Œã‚’æ›´æ–°
                const itemResult = jonState.batchResults.find(r => r.id === itemId);
                if (itemResult) {
                    if (result.registration_pdf_url) {
                        itemResult.registration = { pdf_url: result.registration_pdf_url };
                    }
                    if (result.kozu_pdf_url) {
                        itemResult.kozu_pdf_url = result.kozu_pdf_url;
                    }
                    itemResult.accuracy_warning = null;
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                    renderJonResults(jonState.batchResults);
                }
            } else {
                // ã‚¨ãƒ©ãƒ¼æ™‚
                const errorMsg = result.error || result.detail || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                button.textContent = 'å†è©¦è¡Œ';
                button.disabled = false;
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#dc2626';
                errorDiv.style.fontSize = '0.75rem';
                errorDiv.textContent = errorMsg;
                warningContainer.appendChild(errorDiv);
            }
        } catch (e) {
            console.error('å¼·åˆ¶å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            button.textContent = 'å†è©¦è¡Œ';
            button.disabled = false;
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
    }

    function showRosenkaImage(base64) {
        const imgWindow = window.open('', '_blank');
        if (imgWindow) {
            imgWindow.document.write(`
                <html>
                <head><title>è·¯ç·šä¾¡å›³</title></head>
                <body style="margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f5f5f5;">
                    <img src="data:image/png;base64,${base64}" style="max-width:100%;height:auto;box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                </body>
                </html>
            `);
        }
    }

    function exportJonResults(format) {
        if (!jonState.batchResults.length) return;

        if (format === 'json') {
            const jsonStr = JSON.stringify(jonState.batchResults, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            downloadBlob(blob, 'jon_results.json');
        } else if (format === 'csv') {
            const headers = ['ID', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'Googleãƒãƒƒãƒ—', 'åœ°ä¾¡ãƒãƒƒãƒ—', 'ç™»è¨˜PDF', 'ç·¯åº¦', 'çµŒåº¦', 'v1_code', 'ã‚¨ãƒ©ãƒ¼'];
            const rows = jonState.batchResults.map(r => [
                r.id,
                r.status,
                r.google_map_url || '',
                r.chikamap_url || '',
                r.registration?.pdf_url || '',
                r.location?.lat || '',
                r.location?.long || '',
                r.location?.v1_code || '',
                r.error || '',
            ]);
            const csvContent = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, 'jon_results.csv');
        }
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // Handle JON API integration for nayose results
    function handleNayoseResultsForJon(assets, panel, isConfigured = false, hasToukiCredentials = false) {
        // Convert assets to properties format for JON API
        const properties = assets.flatMap(asset => {
            if (asset.category === 'land' || asset.category === 'building') {
                const notes = asset.notes || '';
                let landType = '';
                let area = '';

                const landTypeMatch = notes.match(/èª²ç¨åœ°ç›®:\s*([^\n]+)/);
                const structureMatch = notes.match(/æ§‹é€ :\s*([^\n]+)/);
                const areaMatch = notes.match(/(?:åœ°ç©|åºŠé¢ç©):\s*([0-9,.]+)/);

                if (landTypeMatch) landType = landTypeMatch[1].trim();
                else if (structureMatch) landType = structureMatch[1].trim();
                if (areaMatch) area = areaMatch[1].trim();

                // Handle nested structure from to_export_payload() and fallback to flat names
                const prefecture = asset.location?.prefecture || asset.location_prefecture || asset.locationPrefecture || '';
                const city = asset.location?.municipality || asset.location_municipality || asset.locationMunicipality || '';
                const address = asset.location?.detail || asset.location_detail || asset.locationDetail || '';
                const identifierPrimary = asset.identifiers?.primary || asset.identifier_primary || asset.identifierPrimary || '';
                const valuationAmount = asset.valuation?.amount ?? asset.valuation_amount ?? asset.valuationAmount ?? '';

                return [{
                    id: identifierPrimary || `prop-${Math.random().toString(36).slice(2)}`,
                    category: asset.category,
                    location_prefecture: prefecture,
                    city: city,
                    address: address,
                    land_type: landType,
                    structure: landType,
                    area: area,
                    value: valuationAmount,
                }];
            }
            return [];
        });

        if (properties.length > 0) {
            renderJonApiPanel(panel, properties, isConfigured, hasToukiCredentials);
        }
    }
})();
</script>

</body>
</html>
