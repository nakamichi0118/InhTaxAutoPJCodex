# SOROBOCR 使い方ガイド

本ガイドでは、SOROBOCR（InhTaxAutoPJ Codex）のWebアプリ/APIを用いて通帳・取引履歴を読み取る手順と、よくある質問をまとめています。最新のフローではGemini 2.5 Pro単体解析が標準となり、高精度なCSVを生成できます。

## 1. 準備

1. **推奨環境**: Google Chrome / Microsoft Edge 最新版。
2. **ファイル形式**: PDF（1口座ごとに1ファイルへまとめてください）。画像からPDFに変換する場合は 600dpi 程度でスキャンしてください。解像度が低すぎると読み取り精度が著しく低下します。
3. **WebアプリURL**: `webapp/index.html` をホスティングした環境、またはローカルで `file://` 直接開いて利用します。`?api=` クエリを指定することで接続先APIを切り替えられます。

## 2. 基本的な使い方

1. ブラウザで Webアプリを開きます。
2. 解析エンジンを選択します（デフォルト: Gemini 2.5 Pro 単体）。必要に応じて Flash や Azureハイブリッドへ切り替え可能です。
3. 日付形式（西暦/和暦）を選択します。判別できない場合は `自動判定` のままで構いません。
4. 「PDFファイルを選択」から通帳PDFをアップロードするか、ドロップエリアにドラッグ＆ドロップして読み取りを開始します。
5. 読み取り完了後、結果タブでサマリ・処理時間・プレビューを確認できます。`CSVダウンロード` セクションから `bank_transactions.csv` などを保存してください。

## 3. 精度・速度の目安

| 解析モード | 精度 | 処理時間 | 備考 |
| --- | --- | --- | --- |
| Gemini 2.5 Pro 単体 | 約99% | ページ数に応じ数分〜10分 | 入出金逆転が稀に発生するため自動補正を実装。最も高精度。 |
| Gemini 2.5 Flash 単体 | 約95% | 中程度 | 軽量だが誤読が増える場合あり。 |
| Azure + Gemini ハイブリッド | 約70% | 最速（1ページあたり1分以内） | Azure中心に処理し、残差が大きい場合のみGemini補正。画質が良い通帳に向く。 |

処理が長時間続く場合は、PDFが極端に大きい/ページ数が多い/解像度が低い可能性があります。Geminiモードは1ページずつ解析して進捗をUIに表示するので、途中で停止しているように見えても裏で処理しています。

## 4. よくある質問 (FAQ)

### Q1. 画質が悪いPDFは読み取れますか？
A. 推奨解像度は 600dpi です。文字が潰れている、濃淡が激しい場合はGemini/ Azureとも精度が落ちます。原本を再スキャンし、なるべくノイズを減らしてください。

### Q2. 通帳の複数口座を1つのPDFにまとめても良いですか？
A. いいえ。1口座ごとにPDFを分けてください。同一ファイルに複数口座が混在すると残高が連続せず、補正ロジックが正常に働きません。

### Q3. 残高がマイナスになる/桁がおかしい場合の対処は？
A. 最新バージョンでは残高推移と摘要キーワードをもとに自動補正しますが、それでも異常値が続く場合は Azure側OCRが誤読している可能性があります。`azure_raw_transactions.csv` をダウンロードして、元データの行を確認してください。

### Q3-1. 合算記帳の通帳は読み取れますか？
A. 複数口座の残高を合算して記帳する形式（合算記帳）は差分ロジックが想定していないため、正常に読み取れない場合があります。できる限り合算前の個別明細でご提供ください。

### Q4. 読み取り完了までの時間はどこで確認できますか？
A. Web UIの結果タブに「処理時間 ○○秒」が表示されます。ログや検証資料に貼り付ける場合は、この数値を活用してください。

### Q5. どの解析モードを使えば良いですか？
A. 高精度が必要な場合は Gemini 2.5 Pro 単体が推奨です。処理速度を優先したい、または Azure環境が整備されている場合はハイブリッドも使用できます。FlashはProより軽量ですが、誤読を目視で確認してください。

### Q6. APIで直接利用する場合のパラメータは？
A. `/api/jobs` に `processing_mode` と `gemini_model` を指定してください（例: `processing_mode=gemini`, `gemini_model=gemini-2.5-pro`）。デフォルトはPro単体です。

## 5. トラブルシューティング

1. **タイムアウトする**: Geminiリクエストがタイムアウトした場合、自動的に小さなチャンクで再試行します。長時間待っても完了しないときは PDF を分割・圧縮し直してください。
2. **通帳のページ順が入れ替わっている**: ページ順を正しい時系列に並べ替えてからアップロードしてください。
3. **結果のCSVが空**: 解析対象が認識されていない可能性があります。通帳以外の書式（手書きメモなど）は未対応です。

---
このガイドは `docs/USAGE.md` としてリポジトリに含まれます。運用中に追加のFAQがあれば更新してください。
