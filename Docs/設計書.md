# 相続税申告書類処理システム - 全体設計仕様書

## システム概要

相続税申告に関する書類を自動読み取りし、財産区分別に分類・リネームを行い、財産目録のExcelファイルで取り込めるようにCSVで出力するともに、リネームしたPDFを生成するシステム。
以下のエクセルに取り込めるようにする。各帳票で取り込む内容もシートに記載がある
C:\Users\iwanaga\社内開発\GAS\相続書類AI-OCR\inheritance-doc-processor\Excel\財産目録 ○○様（更新日）　マクロ ver1.48.00.xlsm

## A. 相続財産評価資料（メインシステム）

### 処理対象書類と区分マッピング

| 書類種別                                                           | 対象区分                                                                       | 処理内容                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------------------------------------------------------ | ------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 登記簿謄本、名寄帳等（固定資産税通知書、評価証明書、名寄帳）       | **土地・建物（実装途中）**                                               | 都道府県（書類に記載がないので所在地からの検索で判定する。　複数候補がある場合はユーザにわかるようにしてプルダウンで選ばせる）、市区町村、大字・丁目、地番、家屋番号、登記地目（登記簿より）、課税地目（名寄帳等より）、持分（これはそもそも誰の評価の判定が必要になるので判定ロジックを相談したい）、地積（名寄帳）、敷地権割合（マンションの場合に建物の登記簿より抽出）、固定資産税評価額（名寄帳等より）抽出して登記簿と名寄帳等の内容を統合する |
| 証券会社の報告書、残高証明書                                       | **上場株式、投資信託**                                                   | 銘柄名、証券会社、支店名、評価額、株式数or口数抽出                                                                                                                                                                                                                                                                                                                                                                                                   |
| 出資証明書等                                                       | **その他の出資金**                                                       | 出資先、出資先の所在地、株数or口数、単価、出資額抽出                                                                                                                                                                                                                                                                                                                                                                                                 |
| 国債・社債の証券                                                   | **公社債**                                                               | 銘柄、細目（公債か社債か）、額面、利率、評価額抽出                                                                                                                                                                                                                                                                                                                                                                                                   |
| 残高証明書                                                         | **預貯金**                                                               | 金融機関、支店、種類（普通預金か定期預金かなど）、口座番号、残高、定期預金については既経過利子抽出                                                                                                                                                                                                                                                                                                                                                   |
| 保険証券、解約返戻金証明書                                         | **生命保険**                                                             | 保険会社等の名称、証券番号、契約者、被保険者、保険金受取人、受取年月日、保険金、解約返戻金抽出                                                                                                                                                                                                                                                                                                                                                       |
| 支払調書                                                           | **死亡退職金（あんまり出てこない）**                                     | 勤務先会社等の名称、証券番号、退職手当金などの名称（退職手当金、確定拠出年金など）、保険金受取人、受取年月日、金額抽出                                                                                                                                                                                                                                                                                                                               |
| 骨董品鑑定書、車検証、還付通知書等                                 | **その他財産**                                                           | 細目（生命保険契約に関する権利,定期金に関する権利,共済契約に関する権利,損害保険契約に関する権利,入院給付金,未収配当金,配当期待権,自動車,構築物,一般動産,死亡一時金,立木,金地金,暗号資産,貸付金預け金等(同族),貸付金預け金等(同族以外),その他財産）、利用区分（建物更生共済,後期高齢者医療高額療養費,住民税,所得税,介護保険料,特約還付金,敷金,特許権,著作権,未収配当金,未収家賃,書画・骨董品,フェンス,アスファルト舗装）、相手方、評価額抽出          |
| 借入金残高証明書、病院代等の領収書、住民税通知書、固定資産税通知書 | **債務（相続開始日以降のものだけが対象となる）**                         | 種類（借入金,未払金,公租公課,預り敷金,預り金）、細目（病院代、電気代など）、支払先氏名、支払先住所、発生年月日、支払年月日、支払額抽出                                                                                                                                                                                                                                                                                                               |
| 葬儀費用領収書、お布施メモ、食事代等                               | **葬式費用**                                                             | 内容（葬儀代、火葬代、お布施等）、支払先氏名、支払先住所、支払年月日、金額抽出                                                                                                                                                                                                                                                                                                                                                                       |
| 通帳、取引履歴                                                     | **通帳（通帳は実装済みだが、表形式の取引履歴も実装しなければならない）** | 年月日、入金、出金、摘要、残高抽出                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 判別不可能な書類                                                   | **不明書類**                                                             | 手動確認待ち                                                                                                                                                                                                                                                                                                                                                                                                                                         |

全ての項目はプルダウンまたは直接修正できるようにしてください。

また財産の分類はOCRだと間違うことがあるのでこちらで修正できるようにしてください。

### アウトプット

1.**財産目録ExcelにとりこめるCSV**: 区分別に整理された財産一覧（1シートにまとめる）
2.**リネームされたPDF**: 区分別フォルダに整理
3.**PDFバインダー**: 印刷・製本用の統合PDF

## B. 手続き関係書類（サブシステム）

### 対象書類

- 戸籍謄本・抄本
- 法定相続情報一覧図
- 印鑑証明書
- 住民票
- 戸籍の附票
- その他手続き関連書類

### 処理内容

- ファイルリネームと書類から被相続人と相続人、相続開始年月日を抽出する
- 被相続人との関係性が兄弟姉妹であったりその他の親族の場合、相続税の2割加算であることを通知する
- 手続き用フォルダへの分類整理

## システムアーキテクチャ

### 技術スタック

* **OCR** : Azure Document Intelligence (カスタムモデル)、GeminiAPI
* **データ処理** : Python (FastAPI)
* **Excel操作** : openpyxl
* **PDF操作** : PyPDF2/PDFtk
* コーディング：Codex
* 全体マネジメント：ClaudeCode
  コンテキストが長くなると忘れてしまうので、うまくmdファイルなどを活用しながら記憶を外部に保存しておく。自律的に動作するように実装方法を考える。
* 実装が完了したらGitHubにプッシュする
* フロントはCloudFLAREとRailwayで処理する
* Dockerは使わずサーバーレスの構造とする
* 各APIキーは.envに記載している
* 通帳処理についてはすでにC:\Users\iwanaga\Development\InhTaxAutoPJ_Codex\Docs\通帳.htmlとC:\Users\iwanaga\Development\InhTaxAutoPJ_Codex\Docs\通帳.jsで実装ができている。この処理を踏襲して作ってほしい。
  なお他社の技術で実装しているOCRも解析したため参考にしてください。C:\Users\iwanaga\Development\InhTaxAutoPJ_Codex\Docs\他社OCR技術仕様書.md
* テスト用のデータは以下に保存している。C:\Users\iwanaga\Development\InhTaxAutoPJ_Codex\test

### リネーム形式

```
V{区分コード}_{連番}_{内容}_{機関名}_{基準日}.pdf

例:
L001_土地登記簿_世田谷区123番地_R05.pdf
B001_建物登記簿_世田谷区456番地_R05.pdf
S001_株式残高証明_野村證券_R051231.pdf
D001_預金残高証明_三菱UFJ銀行_R051231.pdf
T001_通帳_みずほ銀行_R051231.pdf
I001_生命保険証券_日本生命_R05.pdf
O001_骨董品鑑定書_茶碗_R05.pdf
C001_借入残高証明_三井住友銀行_R051231.pdf
F001_葬儀費用_ABC葬祭_R05.pdf
U001_不明書類_xxxxx_R05.pdf
```
