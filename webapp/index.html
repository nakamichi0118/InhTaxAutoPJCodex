<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InhTaxAutoPJ CSV デモ</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #222;
        }
        header {
            background: #1f2937;
            color: white;
            padding: 1.5rem 1rem;
        }
        header h1 {
            margin: 0;
            font-size: 1.4rem;
        }
        main {
            max-width: 960px;
            margin: 0 auto;
            padding: 2rem 1rem 3rem;
        }
        section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            padding: 1.8rem;
            margin-bottom: 1.8rem;
        }
        h2 {
            margin-top: 0;
            font-size: 1.2rem;
            border-left: 4px solid #2563eb;
            padding-left: 0.6rem;
        }
        .input-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid #cbd5f5;
            border-radius: 10px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", monospace;
            font-size: 0.95rem;
            resize: vertical;
            background: #f8fafc;
        }
        button, label.button {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.55rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            background: #2563eb;
            color: white;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        button.secondary, label.button.secondary {
            background: #4b5563;
        }
        button.link-like {
            background: transparent;
            color: #2563eb;
            padding-left: 0;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px rgba(37, 99, 235, 0.25);
        }
        .file-input {
            display: none;
        }
        .status {
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            margin-bottom: 1rem;
            font-size: 0.92rem;
            white-space: pre-wrap;
        }
        .status.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #b91c1c;
        }
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }
        .result-card {
            background: #f8fafc;
            border: 1px solid #dbeafe;
            border-radius: 10px;
            padding: 1rem;
        }
        .result-card h3 {
            margin-top: 0;
            font-size: 1rem;
            color: #1d4ed8;
        }
        .preview {
            overflow-x: auto;
            max-height: 200px;
            background: white;
            border: 1px solid #cbd5f5;
            border-radius: 8px;
            padding: 0.6rem;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre;
        }
        footer {
            text-align: center;
            padding: 2rem 1rem;
            font-size: 0.85rem;
            color: #6b7280;
        }
        @media (max-width: 600px) {
            section {
                padding: 1.2rem;
            }
            textarea {
                min-height: 180px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>InhTaxAutoPJ CSV デモ</h1>
        <p style="margin-top:0.4rem;font-size:0.9rem;color:#d1d5db;">相続書類OCRの正規化JSONをブラウザ内でCSVに変換します。</p>
    </header>
    <main>
        <section>
            <h2>JSON入力</h2>
            <div class="input-row">
                <label class="button secondary" for="inputFile">JSONファイルを選択</label>
                <input type="file" id="inputFile" class="file-input" accept="application/json">
                <button class="secondary" id="loadSample">サンプルJSONを読み込む</button>
            </div>
            <textarea id="jsonInput" placeholder="{\n  &quot;assets&quot;: [ ... ]\n}"></textarea>
            <div class="input-row" style="justify-content:flex-end;">
                <button id="convertBtn">CSVを生成</button>
                <button class="secondary" id="clearBtn">クリア</button>
            </div>
            <div id="status" class="status" style="display:none;"></div>
        </section>

        <section>
            <h2>生成結果</h2>
            <div class="results" id="results"></div>
        </section>
    </main>
    <footer>
        &copy; 2025 InhTaxAutoPJ Codex Demo
    </footer>

<script>
(() => {
    const eraBaseYear = {
        "令和": 2018,
        "平成": 1988,
        "昭和": 1925,
        "大正": 1911,
    };

    const assetColumns = [
        "record_id",
        "source_document",
        "asset_category",
        "asset_type",
        "owner_name",
        "asset_name",
        "location_prefecture",
        "location_municipality",
        "location_detail",
        "identifier_primary",
        "identifier_secondary",
        "valuation_basis",
        "valuation_currency",
        "valuation_amount",
        "valuation_date",
        "ownership_share",
        "notes",
    ];

    const bankColumns = [
        "record_id",
        "transaction_id",
        "transaction_date",
        "value_date",
        "description",
        "withdrawal_amount",
        "deposit_amount",
        "balance",
        "line_confidence",
    ];

    const sampleJson = {
        "assets": [
            {
                "category": "bank_deposit",
                "type": "ordinary_deposit",
                "source_document": "bankbook_001.pdf",
                "owner_name": ["山田 太郎"],
                "asset_name": "三菱UFJ銀行 普通預金",
                "identifiers": {"primary": "1234567", "secondary": "渋谷支店"},
                "valuation": {
                    "basis": "残高証明",
                    "currency": "JPY",
                    "amount": "1,250,000",
                    "date": "2025/01/31"
                },
                "ownership_share": 100,
                "notes": "OCR confidence 0.92",
                "transactions": [
                    {
                        "transaction_date": "2025-01-05",
                        "description": "給与振込",
                        "deposit_amount": 350000,
                        "balance": 1250000,
                        "confidence": 0.88
                    },
                    {
                        "transaction_date": "2025年1月10日",
                        "description": "家賃支払",
                        "withdrawal_amount": 120000,
                        "balance": 1130000,
                        "confidence": 0.82
                    }
                ]
            },
            {
                "category": "land",
                "type": "residential",
                "source_document": "fixed_asset_tax_notice.pdf",
                "owner_name": ["山田 花子", "山田 太郎"],
                "asset_name": "渋谷区松濤 1-2-3",
                "location": {
                    "prefecture": "東京都",
                    "municipality": "渋谷区",
                    "detail": "松濤1丁目2番3"
                },
                "identifiers": {
                    "primary": "渋谷区松濤1丁目2番3",
                    "secondary": "地番 1234-5"
                },
                "valuation": {
                    "basis": "固定資産税評価額",
                    "currency": "JPY",
                    "amount": 85600000,
                    "date": "令和6年1月1日"
                },
                "ownership_share": 50,
                "notes": "共有持分 山田姉弟"
            }
        ]
    };

    const elements = {
        fileInput: document.getElementById("inputFile"),
        loadSampleBtn: document.getElementById("loadSample"),
        convertBtn: document.getElementById("convertBtn"),
        clearBtn: document.getElementById("clearBtn"),
        jsonInput: document.getElementById("jsonInput"),
        status: document.getElementById("status"),
        results: document.getElementById("results"),
    };

    elements.fileInput.addEventListener("change", handleFileSelected);
    elements.loadSampleBtn.addEventListener("click", () => {
        elements.jsonInput.value = JSON.stringify(sampleJson, null, 2);
        showStatus("サンプルJSONを読み込みました。", false);
    });
    elements.convertBtn.addEventListener("click", handleConvert);
    elements.clearBtn.addEventListener("click", () => {
        elements.jsonInput.value = "";
        elements.results.innerHTML = "";
        hideStatus();
    });

    function handleFileSelected() {
        const file = elements.fileInput.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            elements.jsonInput.value = reader.result;
            showStatus(`${file.name} を読み込みました。`, false);
        };
        reader.onerror = () => {
            showStatus("ファイルの読み込みに失敗しました。", true);
        };
        reader.readAsText(file, "utf-8");
    }

    function handleConvert() {
        hideStatus();
        elements.results.innerHTML = "";
        const raw = elements.jsonInput.value.trim();
        if (!raw) {
            showStatus("JSONを入力してください。", true);
            return;
        }
        let parsed;
        try {
            parsed = JSON.parse(raw);
        } catch (error) {
            showStatus(`JSONの解析に失敗しました: ${error.message}`, true);
            return;
        }
        try {
            const { assetRows, bankRows } = convertAssets(parsed);
            if (assetRows.length === 0) {
                showStatus("assets 配列が空、もしくは見つかりませんでした。", true);
                return;
            }
            const assetCsv = buildCsv(assetColumns, assetRows);
            renderResultCard("assets.csv", assetCsv, assetColumns, assetRows.slice(0, 6));
            if (bankRows.length > 0) {
                const bankCsv = buildCsv(bankColumns, bankRows);
                renderResultCard("bank_transactions.csv", bankCsv, bankColumns, bankRows.slice(0, 6));
            }
            showStatus(`CSVを生成しました。${bankRows.length > 0 ? "2ファイル出力" : "1ファイル出力"}。`, false);
        } catch (error) {
            console.error(error);
            showStatus(error.message || "CSV生成中にエラーが発生しました。", true);
        }
    }

    function convertAssets(payload) {
        if (!payload || !Array.isArray(payload.assets)) {
            throw new Error("入力JSONに assets 配列が見つかりません。");
        }
        const assetRows = [];
        const bankRows = [];
        for (const item of payload.assets) {
            if (!item || typeof item !== "object") continue;
            const recordId = deriveRecordId(item);
            assetRows.push(toAssetRow(item, recordId));
            const rows = Array.from(iterTransactions(item, recordId));
            bankRows.push(...rows);
        }
        return { assetRows, bankRows };
    }

    function toAssetRow(asset, recordId) {
        const location = asset.location || {};
        const identifiers = asset.identifiers || {};
        const valuation = asset.valuation || {};
        return {
            record_id: recordId,
            source_document: cleanText(asset.source_document),
            asset_category: cleanText(asset.category),
            asset_type: cleanText(asset.type),
            owner_name: joinNames(asset.owner_name),
            asset_name: cleanText(asset.asset_name),
            location_prefecture: cleanText(location.prefecture),
            location_municipality: cleanText(location.municipality),
            location_detail: cleanText(location.detail),
            identifier_primary: cleanText(identifiers.primary),
            identifier_secondary: cleanText(identifiers.secondary),
            valuation_basis: cleanText(valuation.basis),
            valuation_currency: cleanText(valuation.currency) || "JPY",
            valuation_amount: normalizeDecimal(valuation.amount),
            valuation_date: normalizeDate(valuation.date),
            ownership_share: normalizeDecimal(asset.ownership_share),
            notes: cleanText(asset.notes),
        };
    }

    function* iterTransactions(asset, recordId) {
        const transactions = asset.transactions;
        if (!Array.isArray(transactions) || transactions.length === 0) return;
        let index = 1;
        for (const txn of transactions) {
            if (!txn || typeof txn !== "object") continue;
            yield {
                record_id: recordId,
                transaction_id: `${recordId}-${String(index).padStart(4, "0")}`,
                transaction_date: normalizeDate(txn.transaction_date),
                value_date: normalizeDate(txn.value_date),
                description: cleanText(txn.description),
                withdrawal_amount: normalizeDecimal(txn.withdrawal_amount),
                deposit_amount: normalizeDecimal(txn.deposit_amount),
                balance: normalizeDecimal(txn.balance),
                line_confidence: normalizeDecimal(txn.confidence),
            };
            index += 1;
        }
    }

    function cleanText(value) {
        if (value === undefined || value === null) return "";
        return String(value).trim().replace(/\s+/g, " ");
    }

    function joinNames(value) {
        if (Array.isArray(value)) {
            return value.map(cleanText).filter(Boolean).join(";");
        }
        return cleanText(value);
    }

    function normalizeDecimal(value) {
        if (value === undefined || value === null || value === "") return "";
        if (typeof value === "boolean") return value ? "1" : "0";
        let numericValue;
        if (typeof value === "number") {
            if (!Number.isFinite(value)) return "";
            numericValue = value;
        } else {
            const raw = String(value).replace(/,/g, "").trim();
            if (!raw) return "";
            numericValue = Number(raw);
            if (!Number.isFinite(numericValue)) return cleanText(value);
        }
        const text = numericValue.toLocaleString("en-US", { useGrouping: false, maximumFractionDigits: 12 });
        return text.includes(".") ? text.replace(/0+$/, "").replace(/\.$/, "") : text;
    }

    function normalizeDate(value) {
        if (!value) return "";
        const text = cleanText(value);
        if (!text) return "";
        if (!isNaN(Date.parse(text))) {
            const date = new Date(text);
            return isNaN(date.getTime()) ? text : formatIsoDate(date);
        }
        const compact = text.match(/^(\d{4})(\d{2})(\d{2})$/);
        if (compact) {
            const [_, y, m, d] = compact;
            return safeDate(Number(y), Number(m), Number(d)) || text;
        }
        const separated = text.match(/^(\d{4})[./-](\d{1,2})[./-](\d{1,2})$/);
        if (separated) {
            const [_, y, m, d] = separated;
            return safeDate(Number(y), Number(m), Number(d)) || text;
        }
        const kanji = text.match(/^(\d{4})年(\d{1,2})月(\d{1,2})日$/);
        if (kanji) {
            const [_, y, m, d] = kanji;
            return safeDate(Number(y), Number(m), Number(d)) || text;
        }
        const eraMatch = text.match(/^(令和|平成|昭和|大正)(\d{1,2})年?(\d{1,2})月?(\d{1,2})日?$/);
        if (eraMatch) {
            const [_, era, eraYear, m, d] = eraMatch;
            const base = eraBaseYear[era];
            const year = base + Number(eraYear);
            return safeDate(year, Number(m), Number(d)) || text;
        }
        return text;
    }

    function safeDate(year, month, day) {
        if (!year || !month || !day) return "";
        const date = new Date(Date.UTC(year, month - 1, day));
        if (date.getUTCFullYear() === year && date.getUTCMonth() === month - 1 && date.getUTCDate() === day) {
            return `${year.toString().padStart(4, "0")}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        }
        return "";
    }

    function formatIsoDate(date) {
        return `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, "0")}-${String(date.getUTCDate()).padStart(2, "0")}`;
    }

    function deriveRecordId(asset) {
        if (asset && asset.record_id) return cleanText(asset.record_id);
        const fingerprint = [
            cleanText(asset?.source_document),
            cleanText(asset?.asset_name),
            JSON.stringify(asset?.identifiers || {}, Object.keys(asset?.identifiers || {}).sort()),
            cleanText(asset?.category)
        ].join("|");
        return `rec_${simpleHash(fingerprint)}`;
    }

    function simpleHash(input) {
        let hash = 2166136261;
        for (let i = 0; i < input.length; i += 1) {
            hash ^= input.charCodeAt(i);
            hash = Math.imul(hash, 16777619);
        }
        return (hash >>> 0).toString(16).padStart(8, "0");
    }

    function buildCsv(columns, rows) {
        const lines = [];
        lines.push(columns.join(","));
        for (const row of rows) {
            const values = columns.map((column) => csvEscape(row[column] ?? ""));
            lines.push(values.join(","));
        }
        return "\ufeff" + lines.join("\n");
    }

    function csvEscape(value) {
        const text = String(value ?? "");
        if (text === "") return "";
        if (/["]/.test(text) || /,/.test(text) || /\n/.test(text)) {
            return '"' + text.replace(/"/g, '""') + '"';
        }
        return text;
    }

    function renderResultCard(filename, csvContent, columns, previewRows) {
        const card = document.createElement("div");
        card.className = "result-card";
        const heading = document.createElement("h3");
        heading.textContent = filename;
        const downloadButton = document.createElement("button");
        downloadButton.textContent = "ダウンロード";
        downloadButton.addEventListener("click", () => {
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        const preview = document.createElement("div");
        preview.className = "preview";
        const previewLines = [columns.join(",")];
        previewRows.forEach((row) => {
            const line = columns.map((column) => row[column] ?? "").join(",");
            previewLines.push(line);
        });
        preview.textContent = previewLines.join("\n");
        card.appendChild(heading);
        card.appendChild(downloadButton);
        card.appendChild(preview);
        elements.results.appendChild(card);
    }

    function showStatus(message, isError) {
        elements.status.textContent = message;
        elements.status.classList.toggle("error", !!isError);
        elements.status.style.display = "block";
    }

    function hideStatus() {
        elements.status.style.display = "none";
        elements.status.textContent = "";
        elements.status.classList.remove("error");
    }
})();
</script>
</body>
</html>
